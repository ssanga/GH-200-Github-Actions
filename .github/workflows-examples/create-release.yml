name: ğŸ·ï¸ Crear Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'VersiÃ³n del release (ej: v1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Tipo de release'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
        - prerelease
      prerelease:
        description: 'Es un pre-release?'
        required: false
        default: false
        type: boolean
      release_notes:
        description: 'Notas del release'
        required: false
        type: string

jobs:
  create-release:
    name: ğŸ·ï¸ Crear Release y Tag
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“‹ Validar VersiÃ³n
      run: |
        VERSION="${{ inputs.version }}"
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "âŒ Formato de versiÃ³n invÃ¡lido: $VERSION"
          echo "âœ… Formato esperado: v1.0.0 o v1.0.0-alpha"
          exit 1
        fi
        echo "âœ… Formato de versiÃ³n vÃ¡lido: $VERSION"
    
    - name: ğŸ” Verificar que el Tag no Existe
      run: |
        VERSION="${{ inputs.version }}"
        if git tag -l | grep -q "^$VERSION$"; then
          echo "âŒ El tag $VERSION ya existe"
          exit 1
        fi
        echo "âœ… El tag $VERSION estÃ¡ disponible"
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ§ª Tests Finales Pre-Release
      run: |
        echo "ğŸ§ª Ejecutando tests finales antes del release..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m unittest discover -s . -p "test_*.py" -v
        echo "âœ… Todos los tests pasaron"
    
    - name: ğŸ“ Generar Notas del Release
      id: release_notes
      run: |
        VERSION="${{ inputs.version }}"
        RELEASE_NOTES="${{ inputs.release_notes }}"
        
        if [ -z "$RELEASE_NOTES" ]; then
          # Generar notas automÃ¡ticas basadas en commits
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "## ğŸš€ Cambios desde $LAST_TAG" > release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%an)" $LAST_TAG..HEAD >> release_notes.md
          else
            echo "## ğŸš€ Release Inicial $VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "- VersiÃ³n inicial de la calculadora" >> release_notes.md
            echo "- ImplementaciÃ³n de operaciones bÃ¡sicas" >> release_notes.md
            echo "- Suite completa de tests unitarios" >> release_notes.md
          fi
        else
          echo "$RELEASE_NOTES" > release_notes.md
        fi
        
        echo "ğŸ“ Notas del release generadas:"
        cat release_notes.md
    
    - name: ğŸ·ï¸ Crear Tag
      run: |
        VERSION="${{ inputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a $VERSION -m "Release $VERSION"
        git push origin $VERSION
        echo "âœ… Tag $VERSION creado y pusheado"
    
    - name: ğŸ“¦ Crear Release en GitHub
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ inputs.version }}
        release_name: Release ${{ inputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ inputs.prerelease }}
    
    - name: ğŸ“Š InformaciÃ³n del Release
      run: |
        echo "ğŸ‰ === RELEASE CREADO EXITOSAMENTE ==="
        echo "ğŸ·ï¸ VersiÃ³n: ${{ inputs.version }}"
        echo "ğŸ“¦ Tipo: ${{ inputs.release_type }}"
        echo "ğŸ§ª Pre-release: ${{ inputs.prerelease }}"
        echo "ğŸ‘¤ Creado por: ${{ github.actor }}"
        echo "ğŸ“… Fecha: $(date -Iseconds)"
        echo ""
        echo "ğŸš€ El workflow de despliegue a Production se ejecutarÃ¡ automÃ¡ticamente"
        echo "ğŸ”— Ver release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ inputs.version }}"