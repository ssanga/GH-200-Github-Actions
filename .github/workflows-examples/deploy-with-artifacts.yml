name: ğŸš€ Deploy con Artefactos

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de destino'
        required: true
        type: choice
        options:
        - development
        - staging
        - production
      artifact_run_id:
        description: 'ID del workflow run que generÃ³ el artefacto'
        required: true
        type: string
      version:
        description: 'VersiÃ³n a desplegar'
        required: false
        type: string

jobs:
  deploy:
    name: ğŸš€ Desplegar a ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: 
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://calculadora-app.com' || inputs.environment == 'staging' && 'https://staging.calculadora-app.com' || 'https://dev.calculadora-app.com' }}
    
    steps:
    - name: ğŸ“‹ InformaciÃ³n del Despliegue
      run: |
        echo "ğŸš€ === DESPLIEGUE CON ARTEFACTO ==="
        echo "ğŸ¯ Entorno: ${{ inputs.environment }}"
        echo "ğŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ğŸ†” Artifact Run ID: ${{ inputs.artifact_run_id }}"
        echo "ğŸ·ï¸ VersiÃ³n: ${{ inputs.version || 'Latest' }}"
        echo "ğŸ“… Fecha: $(date -Iseconds)"
        echo "ğŸ”— URL: ${{ inputs.environment == 'production' && 'https://calculadora-app.com' || inputs.environment == 'staging' && 'https://staging.calculadora-app.com' || 'https://dev.calculadora-app.com' }}"
    
    - name: ğŸ“¥ Descargar Artefacto
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ inputs.artifact_run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./artifacts
    
    - name: ğŸ” Listar Artefactos Disponibles
      run: |
        echo "ğŸ“¦ Artefactos disponibles:"
        find ./artifacts -type f -name "*.zip" | while read file; do
          echo "  ğŸ“ $(basename "$file")"
        done
    
    - name: ğŸ“¦ Extraer Artefacto Principal
      run: |
        echo "ğŸ“¦ Extrayendo artefacto para ${{ inputs.environment }}..."
        
        # Buscar el artefacto principal (calculadora-*)
        ARTIFACT_ZIP=$(find ./artifacts -name "calculadora-*.zip" | head -1)
        
        if [ -n "$ARTIFACT_ZIP" ]; then
          echo "ğŸ“ Usando artefacto: $(basename "$ARTIFACT_ZIP")"
          
          # Crear directorio de despliegue
          mkdir -p deploy
          cd deploy
          
          # Extraer artefacto
          unzip -q "../$ARTIFACT_ZIP"
          
          # Encontrar directorio extraÃ­do
          ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
          
          if [ -n "$ARTIFACT_DIR" ]; then
            echo "ğŸ“‚ Directorio extraÃ­do: $ARTIFACT_DIR"
            
            # Mostrar informaciÃ³n del build original
            echo "ğŸ“‹ InformaciÃ³n del build original:"
            cat "$ARTIFACT_DIR/build-info.json" | python3 -m json.tool
            
            # Configurar para el entorno especÃ­fico
            echo "" >> "$ARTIFACT_DIR/.env"
            echo "# ConfiguraciÃ³n de despliegue" >> "$ARTIFACT_DIR/.env"
            echo "ENVIRONMENT=${{ inputs.environment }}" >> "$ARTIFACT_DIR/.env"
            echo "DEPLOYED_AT=$(date -Iseconds)" >> "$ARTIFACT_DIR/.env"
            echo "DEPLOYED_BY=${{ github.actor }}" >> "$ARTIFACT_DIR/.env"
            echo "DEPLOYMENT_RUN_ID=${{ github.run_id }}" >> "$ARTIFACT_DIR/.env"
            
            # Configuraciones especÃ­ficas por entorno
            case "${{ inputs.environment }}" in
              "production")
                echo "LOG_LEVEL=ERROR" >> "$ARTIFACT_DIR/.env"
                echo "DEBUG=false" >> "$ARTIFACT_DIR/.env"
                echo "MONITORING=true" >> "$ARTIFACT_DIR/.env"
                ;;
              "staging")
                echo "LOG_LEVEL=INFO" >> "$ARTIFACT_DIR/.env"
                echo "DEBUG=false" >> "$ARTIFACT_DIR/.env"
                echo "MONITORING=true" >> "$ARTIFACT_DIR/.env"
                ;;
              "development")
                echo "LOG_LEVEL=DEBUG" >> "$ARTIFACT_DIR/.env"
                echo "DEBUG=true" >> "$ARTIFACT_DIR/.env"
                echo "MONITORING=false" >> "$ARTIFACT_DIR/.env"
                ;;
            esac
            
            echo "âœ… Artefacto preparado para ${{ inputs.environment }}"
          else
            echo "âŒ No se pudo encontrar el directorio del artefacto"
            exit 1
          fi
        else
          echo "âŒ No se encontrÃ³ artefacto de calculadora"
          exit 1
        fi
    
    - name: ğŸ”’ Validaciones Pre-Despliegue
      run: |
        cd deploy
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ğŸ”’ Ejecutando validaciones para ${{ inputs.environment }}..."
        
        # Validaciones especÃ­ficas por entorno
        case "${{ inputs.environment }}" in
          "production")
            echo "ğŸ” Validaciones crÃ­ticas de producciÃ³n..."
            # Verificar que existe el archivo principal
            if [ ! -f "$ARTIFACT_DIR/calculadora.py" ]; then
              echo "âŒ Archivo principal no encontrado"
              exit 1
            fi
            # Verificar integridad del build
            if [ ! -f "$ARTIFACT_DIR/build-info.json" ]; then
              echo "âŒ InformaciÃ³n de build no encontrada"
              exit 1
            fi
            ;;
          "staging")
            echo "ğŸ§ª Validaciones de staging..."
            ;;
          "development")
            echo "ğŸ› ï¸ Validaciones de development..."
            ;;
        esac
        
        echo "âœ… Validaciones completadas"
    
    - name: ğŸš€ Ejecutar Despliegue
      run: |
        cd deploy
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ğŸš€ Desplegando a ${{ inputs.environment }}..."
        echo ""
        echo "ğŸ“ Contenido a desplegar:"
        ls -la "$ARTIFACT_DIR/"
        echo ""
        echo "ğŸ”§ ConfiguraciÃ³n final del entorno:"
        cat "$ARTIFACT_DIR/.env"
        echo ""
        
        # Simular despliegue especÃ­fico por entorno
        case "${{ inputs.environment }}" in
          "production")
            echo "ğŸ­ Desplegando a PRODUCTION..."
            echo "  - Activando modo de alta disponibilidad"
            echo "  - Configurando balanceadores de carga"
            echo "  - Activando monitoreo avanzado"
            sleep 5
            ;;
          "staging")
            echo "ğŸ­ Desplegando a STAGING..."
            echo "  - Configurando entorno de pruebas"
            echo "  - Activando logs detallados"
            sleep 3
            ;;
          "development")
            echo "ğŸ› ï¸ Desplegando a DEVELOPMENT..."
            echo "  - Configurando modo debug"
            echo "  - Activando hot-reload"
            sleep 2
            ;;
        esac
        
        echo "âœ… Despliegue completado exitosamente"
        echo "ğŸ”— AplicaciÃ³n disponible en: ${{ inputs.environment == 'production' && 'https://calculadora-app.com' || inputs.environment == 'staging' && 'https://staging.calculadora-app.com' || 'https://dev.calculadora-app.com' }}"
    
    - name: ğŸ§ª Tests Post-Despliegue
      run: |
        cd deploy
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ğŸ§ª Ejecutando tests post-despliegue en ${{ inputs.environment }}..."
        
        # Ejecutar la aplicaciÃ³n para verificar que funciona
        cd "$ARTIFACT_DIR"
        python calculadora.py
        
        # Tests especÃ­ficos por entorno
        case "${{ inputs.environment }}" in
          "production")
            echo "ğŸ” Tests crÃ­ticos de producciÃ³n..."
            echo "  âœ… AplicaciÃ³n responde correctamente"
            echo "  âœ… ConfiguraciÃ³n de producciÃ³n aplicada"
            ;;
          "staging")
            echo "ğŸ§ª Tests de integraciÃ³n en staging..."
            echo "  âœ… Funcionalidad bÃ¡sica verificada"
            ;;
          "development")
            echo "ğŸ› ï¸ Tests de desarrollo..."
            echo "  âœ… Modo debug activado"
            ;;
        esac
        
        echo "âœ… Todos los tests post-despliegue pasaron"
    
    - name: ğŸ“Š Reporte Final
      run: |
        echo "ğŸ‰ === DESPLIEGUE COMPLETADO EXITOSAMENTE ==="
        echo "ğŸ¯ Entorno: ${{ inputs.environment }}"
        echo "ğŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ğŸ†” Artifact Run ID: ${{ inputs.artifact_run_id }}"
        echo "ğŸ·ï¸ VersiÃ³n: ${{ inputs.version || 'Latest' }}"
        echo "ğŸ“… Completado: $(date -Iseconds)"
        echo "ğŸ”— URL: ${{ inputs.environment == 'production' && 'https://calculadora-app.com' || inputs.environment == 'staging' && 'https://staging.calculadora-app.com' || 'https://dev.calculadora-app.com' }}"
        echo ""
        echo "ğŸ“‹ PrÃ³ximos pasos:"
        case "${{ inputs.environment }}" in
          "production")
            echo "  - Monitorear mÃ©tricas de aplicaciÃ³n"
            echo "  - Verificar logs de errores"
            echo "  - Confirmar funcionalidad con usuarios"
            ;;
          "staging")
            echo "  - Ejecutar tests de integraciÃ³n completos"
            echo "  - Validar con equipo de QA"
            echo "  - Preparar para producciÃ³n"
            ;;
          "development")
            echo "  - Continuar desarrollo"
            echo "  - Ejecutar tests locales"
            echo "  - Preparar para staging"
            ;;
        esac