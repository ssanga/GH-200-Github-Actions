name: ğŸ­ Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers en tags como v1.0.0, v2.1.3, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'VersiÃ³n a desplegar (ej: v1.0.0)'
        required: true
        type: string
      rollback:
        description: 'Es un rollback?'
        required: false
        default: false
        type: boolean

jobs:
  validate-release:
    name: ğŸ” Validar Release
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ·ï¸ Determinar VersiÃ³n
      id: version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="${{ inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Verificar si es pre-release (contiene alpha, beta, rc)
        if [[ $VERSION =~ (alpha|beta|rc) ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ“‹ VersiÃ³n detectada: $VERSION"
        echo "ğŸ” Es pre-release: $(echo $VERSION | grep -E '(alpha|beta|rc)' && echo 'true' || echo 'false')"
    
    - name: ğŸ“Š InformaciÃ³n del Release
      run: |
        echo "ğŸ­ === VALIDACIÃ“N DE RELEASE PARA PRODUCTION ==="
        echo "ğŸ·ï¸ VersiÃ³n: ${{ steps.version.outputs.version }}"
        echo "ğŸ‘¤ Solicitado por: ${{ github.actor }}"
        echo "ğŸ†” Commit: ${{ github.sha }}" | cut -c1-8
        echo "ğŸ“… Fecha: $(date -Iseconds)"
        echo "ğŸ”„ Es rollback: ${{ inputs.rollback || 'false' }}"
        echo "ğŸ§ª Es pre-release: ${{ steps.version.outputs.is_prerelease }}"
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ§ª Validaciones CrÃ­ticas
      run: |
        echo "ğŸ§ª Ejecutando validaciones crÃ­ticas para Production..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Tests crÃ­ticos
        python -m unittest discover -s . -p "test_*.py" -v
        
        # Verificar que la aplicaciÃ³n arranca
        python calculadora.py
        
        echo "âœ… Todas las validaciones crÃ­ticas pasaron"

  deploy-production:
    name: ğŸ­ Despliegue a Production
    runs-on: ubuntu-latest
    needs: validate-release
    environment: 
      name: production
      url: https://calculadora-app.com
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ“‹ InformaciÃ³n del Despliegue Production
      run: |
        echo "ğŸ­ === DESPLIEGUE A PRODUCTION ==="
        echo "ğŸ·ï¸ VersiÃ³n: ${{ needs.validate-release.outputs.version }}"
        echo "ğŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ğŸ†” Commit: ${{ github.sha }}" | cut -c1-8
        echo "ğŸ“… Fecha: $(date -Iseconds)"
        echo "ğŸ¯ Entorno: Production"
        echo "ğŸ”— URL: https://calculadora-app.com"
        echo "ğŸ”„ Es rollback: ${{ inputs.rollback || 'false' }}"
        echo "ğŸ§ª Es pre-release: ${{ needs.validate-release.outputs.is_prerelease }}"
    
    - name: ğŸ“¦ Build para Production
      run: |
        echo "ğŸ”¨ Construyendo aplicaciÃ³n para Production..."
        mkdir -p dist
        cp calculadora.py dist/
        echo "VERSION=${{ needs.validate-release.outputs.version }}" > dist/.env
        echo "ENVIRONMENT=production" >> dist/.env
        echo "BUILD_DATE=$(date -Iseconds)" >> dist/.env
        echo "DEPLOYED_BY=${{ github.actor }}" >> dist/.env
        echo "COMMIT_SHA=${{ github.sha }}" >> dist/.env
        echo "IS_ROLLBACK=${{ inputs.rollback || 'false' }}" >> dist/.env
        echo "âœ… Build para Production completado"
    
    - name: ğŸ”’ Validaciones de Seguridad Avanzadas
      run: |
        echo "ğŸ”’ Ejecutando validaciones de seguridad avanzadas..."
        pip install bandit
        bandit -r . --exclude ./test_*.py -f json -o security-report.json || true
        echo "ğŸ” Verificando configuraciÃ³n de producciÃ³n..."
        echo "âœ… Validaciones de seguridad completadas"
    
    - name: ğŸ’¾ Backup Pre-Despliegue
      if: ${{ inputs.rollback != 'true' }}
      run: |
        echo "ğŸ’¾ Creando backup pre-despliegue..."
        echo "ğŸ“‹ Backup de la versiÃ³n anterior simulado"
        echo "ğŸ—ƒï¸ Backup ID: backup-$(date +%Y%m%d-%H%M%S)"
        echo "âœ… Backup completado"
    
    - name: ğŸš€ Despliegue a Production
      run: |
        echo "ğŸš€ Desplegando a Production..."
        echo "ğŸ“ Contenido a desplegar:"
        ls -la dist/
        echo ""
        echo "ğŸ”§ ConfiguraciÃ³n del entorno:"
        cat dist/.env
        echo ""
        if [ "${{ inputs.rollback }}" == "true" ]; then
          echo "ğŸ”„ Ejecutando ROLLBACK a versiÃ³n anterior..."
        else
          echo "ğŸŒ Ejecutando despliegue normal a Production..."
        fi
        sleep 5
        echo "âœ… AplicaciÃ³n desplegada exitosamente en Production"
        echo "ğŸ”— Disponible en: https://calculadora-app.com"
    
    - name: ğŸ§ª Tests de ProducciÃ³n
      run: |
        echo "ğŸ§ª Ejecutando tests de producciÃ³n..."
        python calculadora.py
        echo "ğŸ” Verificando health checks..."
        echo "ğŸ“Š Verificando mÃ©tricas bÃ¡sicas..."
        echo "âœ… Tests de producciÃ³n pasaron correctamente"
    
    - name: ğŸ“Š Reporte Final de Despliegue
      run: |
        echo "ğŸ“¢ === REPORTE FINAL DE DESPLIEGUE PRODUCTION ==="
        echo "âœ… Despliegue a Production completado exitosamente"
        echo "ğŸ·ï¸ VersiÃ³n: ${{ needs.validate-release.outputs.version }}"
        echo "ğŸ‘¤ Por: ${{ github.actor }}"
        echo "ğŸ†” Commit: ${{ github.sha }}"
        echo "â° En: $(date)"
        echo "ğŸ”— URL: https://calculadora-app.com"
        echo "ğŸ”„ Tipo: ${{ inputs.rollback == 'true' && 'ROLLBACK' || 'DESPLIEGUE NORMAL' }}"
        echo ""
        echo "ğŸ“‹ Post-despliegue:"
        echo "- Monitorear mÃ©tricas de aplicaciÃ³n"
        echo "- Verificar logs de errores"
        echo "- Confirmar funcionalidad con usuarios"
        echo "- Actualizar documentaciÃ³n de release"
    
    - name: ğŸ“¤ Subir Reportes
      uses: actions/upload-artifact@v4
      with:
        name: production-deployment-${{ needs.validate-release.outputs.version }}
        path: |
          dist/.env
          security-report.json
        retention-days: 90