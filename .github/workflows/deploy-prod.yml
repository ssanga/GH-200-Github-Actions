# Pipeline por Entorno: Production
# Workflow especÃ­fico para el entorno de producciÃ³n
# Trigger: Push a rama 'production' o 'main' con tag, o workflow_dispatch

name: ğŸŒŸ Deploy to Production

# Triggers especÃ­ficos para producciÃ³n
on:
  push:
    branches:
      - production
      - main  # Solo con protecciÃ³n adicional
    tags:
      - 'v*.*.*'  # Releases semÃ¡nticos
  
  # Trigger manual con aprobaciÃ³n requerida
  workflow_dispatch:
    inputs:
      version:
        description: 'VersiÃ³n a desplegar (ej: v1.2.3)'
        required: true
        type: string
      emergency_deploy:
        description: 'Deploy de emergencia (skip algunos checks)'
        required: false
        default: false
        type: boolean
      rollback_version:
        description: 'VersiÃ³n de rollback (opcional)'
        required: false
        type: string

# Variables especÃ­ficas del entorno Production
env:
  ENVIRONMENT: 'production'
  NODE_ENV: 'production'
  PYTHON_VERSION: '3.9'
  DEBUG: 'false'
  LOG_LEVEL: 'error'  # Solo errores en producciÃ³n
  
  # URLs de producciÃ³n
  API_URL: 'https://api.calculadora.example.com'
  WEB_URL: 'https://calculadora.example.com'
  DATABASE_URL: 'postgresql://prod-db.example.com/calculadora_prod'
  
  # Configuraciones de producciÃ³n (mÃ¡s restrictivas)
  CACHE_TTL: '3600'  # 1 hora
  RATE_LIMIT: '100'  # LÃ­mite conservador
  SSL_REQUIRED: 'true'
  
jobs:
  # ===============================================
  # JOB 1: VALIDACIÃ“N PREVIA PARA PRODUCCIÃ“N
  # ===============================================
  pre-production-validation:
    name: ğŸ” Pre-Production Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Validate production readiness
        run: |
          echo "ğŸ” Validando preparaciÃ³n para producciÃ³n..."
          
          # Verificar que no estamos en una rama de desarrollo
          if [[ "${{ github.ref_name }}" == "dev"* ]] || [[ "${{ github.ref_name }}" == "feature"* ]]; then
            echo "âŒ ERROR: No se puede desplegar rama de desarrollo a producciÃ³n"
            exit 1
          fi
          
          # Verificar formato de versiÃ³n si es un tag
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            if [[ ! "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "âŒ ERROR: Tag no sigue semÃ¡ntica vX.Y.Z"
              exit 1
            fi
          fi
          
          # Verificar que existe el archivo de aplicaciÃ³n
          if [[ ! -f "calculadora.py" ]]; then
            echo "âŒ ERROR: Archivo principal no encontrado"
            exit 1
          fi
          
          echo "âœ… ValidaciÃ³n previa completada"
          
    outputs:
      validation-status: success
      
  # ===============================================
  # JOB 2: BUILD PARA PRODUCCIÃ“N
  # ===============================================
  build-production:
    name: ğŸ·ï¸ Build for Production
    runs-on: ubuntu-latest
    needs: pre-production-validation
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # Herramientas de producciÃ³n
          pip install pytest pytest-cov bandit safety wheel
          
      - name: ğŸ”’ Security audit (Production)
        run: |
          echo "ğŸ”’ Ejecutando auditorÃ­a de seguridad para producciÃ³n..."
          
          # Check crÃ­tico de vulnerabilidades
          echo "  â–¶ Audit crÃ­tico de dependencias..."
          safety check --full-report
          
          # AnÃ¡lisis de seguridad estricto
          echo "  â–¶ AnÃ¡lisis de seguridad del cÃ³digo (CRITÃCO)..."
          bandit -r . -ll -f json -o security-report.json
          
          # Verificar que no hay issues de alta severidad
          if grep -q '"issue_severity": "HIGH"' security-report.json; then
            echo "âŒ ERROR: Issues de seguridad de alta severidad encontrados"
            cat security-report.json
            exit 1
          fi
          
          echo "âœ… AuditorÃ­a de seguridad completada"
          
      - name: ğŸ§ª Production test suite
        if: ${{ !inputs.emergency_deploy }}
        run: |
          echo "ğŸ§ª Ejecutando suite completa de producciÃ³n..."
          
          # Tests con cobertura obligatoria del 95%
          pytest test_calculadora.py -v \
            --cov=calculadora \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=95 \
            --tb=short
          
          echo "âœ… Tests de producciÃ³n completados"
          
      - name: ğŸ·ï¸ Generate production build
        run: |
          echo "ğŸ·ï¸ Generando build optimizado para producciÃ³n..."
          
          mkdir -p dist-production
          
          # Crear configuraciÃ³n de producciÃ³n
          cat > dist-production/config.py << 'EOF'
          # ConfiguraciÃ³n de ProducciÃ³n
          import os
          
          class ProductionConfig:
              DEBUG = False
              TESTING = False
              LOG_LEVEL = 'ERROR'  # Solo errores
              
              # URLs de producciÃ³n
              API_URL = '${{ env.API_URL }}'
              WEB_URL = '${{ env.WEB_URL }}'
              DATABASE_URL = '${{ env.DATABASE_URL }}'
              
              # Configuraciones optimizadas para producciÃ³n
              CACHE_TTL = ${{ env.CACHE_TTL }}
              RATE_LIMIT = ${{ env.RATE_LIMIT }}
              SSL_REQUIRED = ${{ env.SSL_REQUIRED }}
              
              # Configuraciones de seguridad mÃ¡xima
              SECURE_COOKIES = True
              SECURE_SSL_REDIRECT = True
              SESSION_TIMEOUT = 1800  # 30 minutos
              MAX_CONTENT_LENGTH = 1 * 1024 * 1024  # 1MB lÃ­mite estricto
              
              # Configuraciones de producciÃ³n
              ENABLE_MONITORING = True
              ENABLE_METRICS = True
              ENABLE_ALERTING = True
              ALLOW_CORS = False
              
              # ConfiguraciÃ³n de rendimiento
              MAX_CONNECTIONS = 100
              CONNECTION_TIMEOUT = 30
              REQUEST_TIMEOUT = 60
              
          config = ProductionConfig()
          EOF
          
          # Copiar solo archivos necesarios para producciÃ³n
          cp calculadora.py dist-production/
          cp requirements.txt dist-production/
          
          # Crear manifiesto de versiÃ³n
          VERSION="${{ github.ref_name }}"
          if [[ "${{ github.ref_type }}" != "tag" ]]; then
            VERSION="production-${{ github.run_number }}"
          fi
          
          cat > dist-production/version.json << EOF
          {
            "version": "$VERSION",
            "environment": "${{ env.ENVIRONMENT }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "build_time": "$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")",
            "build_number": "${{ github.run_number }}",
            "build_actor": "${{ github.actor }}",
            "urls": {
              "api": "${{ env.API_URL }}",
              "web": "${{ env.WEB_URL }}"
            },
            "security": {
              "ssl_enforced": true,
              "rate_limited": true,
              "security_scan": "passed"
            },
            "quality": {
              "test_coverage": ">=95%",
              "security_audit": "passed",
              "performance_tested": true
            }
          }
          EOF
          
          # Crear checksum para verificaciÃ³n
          find dist-production -type f -exec sha256sum {} \; > dist-production/checksums.txt
          
      - name: ğŸ“¤ Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculadora-production-${{ github.run_number }}
          path: dist-production/
          retention-days: 90  # RetenciÃ³n larga para producciÃ³n
          
    outputs:
      artifact-name: calculadora-production-${{ github.run_number }}
      build-url: ${{ env.WEB_URL }}
      version: ${{ github.ref_name }}
      
  # ===============================================
  # JOB 3: DEPLOY A PRODUCCIÃ“N (CON APROBACIÃ“N)
  # ===============================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: [pre-production-validation, build-production]
    environment:
      name: production
      url: ${{ env.WEB_URL }}
    
    steps:
      - name: ğŸ“¥ Download production artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-production.outputs.artifact-name }}
          path: ./deploy-production
          
      - name: ğŸ” Verify production artifact integrity
        run: |
          echo "ğŸ” Verificando integridad del artifact de producciÃ³n..."
          cd ./deploy-production
          
          # Verificar checksums
          echo "  â–¶ Verificando checksums..."
          sha256sum -c checksums.txt
          
          echo "ğŸ“„ InformaciÃ³n de versiÃ³n:"
          cat version.json | jq .
          
          echo "âš™ï¸ ConfiguraciÃ³n de producciÃ³n:"
          head -40 config.py
          
          echo "âœ… Artifact verificado correctamente"
          
      - name: ğŸŒŸ Setup production environment
        run: |
          echo "ğŸŒŸ Configurando entorno de producciÃ³n..."
          
          # ConfiguraciÃ³n crÃ­tica de producciÃ³n
          echo "  â–¶ Configurando variables crÃ­ticas..."
          echo "ENVIRONMENT=${{ env.ENVIRONMENT }}" >> $GITHUB_ENV
          echo "LOG_LEVEL=${{ env.LOG_LEVEL }}" >> $GITHUB_ENV
          echo "SSL_REQUIRED=${{ env.SSL_REQUIRED }}" >> $GITHUB_ENV
          
          echo "  â–¶ Validando servicios de producciÃ³n..."
          echo "    - Base de datos: ${{ env.DATABASE_URL }}"
          echo "    - API (SSL): ${{ env.API_URL }}"
          echo "    - Cache TTL: ${{ env.CACHE_TTL }}s"
          echo "    - Rate Limit: ${{ env.RATE_LIMIT }} req/min (ESTRICTO)"
          
          echo "  â–¶ Verificando conectividad crÃ­tica..."
          # Simular health checks crÃ­ticos
          sleep 3
          
          echo "  â–¶ Configurando monitoreo y alertas..."
          sleep 2
          
          echo "âœ… Entorno de producciÃ³n listo y monitoreado"
          
      - name: ğŸ”¥ Pre-deployment smoke tests
        run: |
          echo "ğŸ”¥ Ejecutando smoke tests crÃ­ticos pre-deployment..."
          cd ./deploy-production
          
          # Tests crÃ­ticos que DEBEN pasar antes del deploy
          python -c "
          import sys, json
          sys.path.append('.')
          
          from calculadora import Calculadora
          from config import config
          
          print('ğŸŒŸ PRODUCCIÃ“N - Smoke Tests CrÃ­ticos')
          print('=' * 50)
          
          # Verificar configuraciÃ³n de producciÃ³n
          assert not config.DEBUG, 'DEBUG debe estar deshabilitado'
          assert not config.TESTING, 'TESTING debe estar deshabilitado'
          assert config.SSL_REQUIRED, 'SSL debe estar requerido'
          print('âœ… ConfiguraciÃ³n de producciÃ³n: OK')
          
          # Tests funcionales crÃ­ticos
          calc = Calculadora()
          
          critical_tests = [
              (calc.sumar, [100, 200], 300),
              (calc.restar, [1000, 300], 700),
              (calc.multiplicar, [25, 4], 100),
              (calc.dividir, [1000, 25], 40.0),
              (calc.potencia, [10, 2], 100),
              (calc.raiz_cuadrada, [144], 12.0)
          ]
          
          for func, args, expected in critical_tests:
              result = func(*args)
              assert result == expected, f'CRITICAL FAILURE: {func.__name__}{args}'
              print(f'âœ… {func.__name__}{args} = {result}')
          
          # Tests de casos lÃ­mite crÃ­ticos
          try:
              calc.dividir(1, 0)
              raise AssertionError('CRITICAL: DivisiÃ³n por cero no controlada')
          except ValueError:
              print('âœ… Control divisiÃ³n por cero: OK')
          
          try:
              calc.raiz_cuadrada(-4)
              raise AssertionError('CRITICAL: RaÃ­z negativa no controlada')
          except ValueError:
              print('âœ… Control raÃ­z negativa: OK')
          
          print('âœ… TODOS LOS SMOKE TESTS CRÃTICOS PASARON')
          print('Listo para deployment a producciÃ³n')
          "
          
      - name: ğŸŒŸ Deploy to Production (Blue-Green)
        run: |
          echo "ğŸŒŸ DESPLEGANDO A PRODUCCIÃ“N - Blue-Green Deployment"
          echo "======================================================"
          
          # Blue-Green deployment para producciÃ³n
          echo "  ğŸ“ˆ Production deployment config:"
          echo "    - Environment: ${{ env.ENVIRONMENT }}"
          echo "    - Version: ${{ needs.build-production.outputs.version }}"
          echo "    - SSL Required: ${{ env.SSL_REQUIRED }}"
          echo "    - URL: ${{ env.WEB_URL }}"
          echo "    - Artifact: ${{ needs.build-production.outputs.artifact-name }}"
          
          # Deployment de producciÃ³n con mÃ¡xima precauciÃ³n
          echo ""
          echo "  â–¶ [1/8] Creando snapshot de base de datos..."
          sleep 3
          
          echo "  â–¶ [2/8] Preparando entorno blue (nuevo)..."
          sleep 4
          
          echo "  â–¶ [3/8] Desplegando aplicaciÃ³n en blue..."
          sleep 5
          
          echo "  â–¶ [4/8] Ejecutando health checks extensivos..."
          sleep 4
          
          echo "  â–¶ [5/8] Validando conectividad de servicios..."
          sleep 3
          
          echo "  â–¶ [6/8] Ejecutando tests de regresiÃ³n..."
          sleep 3
          
          echo "  â–¶ [7/8] Switcheando trÃ¡fico a blue (5% -> 25% -> 100%)..."
          echo "    - 5% del trÃ¡fico..."
          sleep 2
          echo "    - 25% del trÃ¡fico..."
          sleep 3
          echo "    - 100% del trÃ¡fico..."
          sleep 2
          
          echo "  â–¶ [8/8] Finalizando y liberando entorno green (anterior)..."
          sleep 2
          
          echo ""
          echo "âœ… DEPLOYMENT A PRODUCCIÃ“N COMPLETADO"
          echo "ğŸ“Š MÃ©tricas de deployment:"
          echo "  - Tiempo total: ~30 segundos"
          echo "  - Downtime: 0 segundos (blue-green)"
          echo "  - Health checks: Passed"
          echo "  - SSL: Enforced"
          echo "  - Rate limiting: Active"
          echo "  - Monitoring: Enabled"
          
      - name: ğŸ“ Update production status
        run: |
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "deployment_url=${{ env.WEB_URL }}" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "version=${{ needs.build-production.outputs.version }}" >> $GITHUB_OUTPUT
          
  # ===============================================
  # JOB 4: POST-DEPLOYMENT PARA PRODUCCIÃ“N
  # ===============================================
  post-deploy-production:
    name: ğŸ“Š Post-Deployment Production Monitoring
    runs-on: ubuntu-latest
    needs: [build-production, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“Š Production metrics and alerts
        run: |
          echo "ğŸ“Š MÃ©tricas crÃ­ticas de producciÃ³n:"
          echo "  ğŸŒŸ Environment: production"
          echo "  ğŸŒ¿ Version: ${{ needs.build-production.outputs.version }}"
          echo "  ğŸ“¦ Artifact: ${{ needs.build-production.outputs.artifact-name }}"
          echo "  ğŸ”— URL: ${{ needs.build-production.outputs.build-url }}"
          echo "  â±ï¸ Deploy time: $(date '+%H:%M:%S %Z')"
          echo "  ğŸ“Š Status: ${{ needs.deploy-production.result }}"
          echo "  ğŸ‘¤ Deployer: ${{ github.actor }}"
          
          # Simular envÃ­o de mÃ©tricas crÃ­ticas
          echo ""
          echo "  ğŸ“Š Enviando mÃ©tricas crÃ­ticas..."
          echo "    - Response time: <100ms"
          echo "    - Memory usage: 32MB"
          echo "    - CPU usage: 8%"
          echo "    - Error rate: 0%"
          echo "    - Uptime: 99.99%"
          
          # Configurar alertas
          echo "  ğŸš¨ Configurando alertas de producciÃ³n..."
          echo "    - Error rate > 1%: CRITICAL"
          echo "    - Response time > 500ms: WARNING"
          echo "    - Memory > 80%: WARNING"
          echo "    - Downtime: CRITICAL"
          
      - name: ğŸ“¢ Production deployment notification
        run: |
          if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "âœ… ğŸ† PRODUCCIÃ“N - Deployment exitoso"
            echo "================================================"
            echo "  ğŸŒŸ VersiÃ³n: ${{ needs.build-production.outputs.version }}"
            echo "  ğŸ”— URL: ${{ needs.build-production.outputs.build-url }}"
            echo "  ğŸ‘¤ Deployer: ${{ github.actor }}"
            echo "  â° Tiempo: $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "  ğŸ”’ Seguridad: SSL enforced, Rate limited"
            echo "  ğŸ§ª Tests: 95%+ coverage, Security audited"
            echo "  ğŸ“Š Monitoreo: Activo, Alertas configuradas"
            echo ""
            echo "  ğŸ“¢ @everyone - Nueva versiÃ³n en producciÃ³n"
            echo "  ğŸ” Monitor: ${{ needs.build-production.outputs.build-url }}/health"
          else
            echo "âŒ ğŸš¨ PRODUCCIÃ“N - DEPLOYMENT FALLIDO"
            echo "============================================"
            echo "  ğŸŒ¿ VersiÃ³n: ${{ needs.build-production.outputs.version }}"
            echo "  ğŸ‘¤ Deployer: ${{ github.actor }}"
            echo "  ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo ""
            echo "  ğŸš¨ @oncall @devteam - INCIDENTE DE PRODUCCIÃ“N"
            echo "  ğŸ”„ Rollback necesario si es crÃ­tico"
          fi
          
          # En un entorno real: notificaciÃ³n CRITICA a mÃºltiples canales
          echo "ğŸ“§ NotificaciÃ³n crÃ­tica de producciÃ³n enviada"
          
      - name: ğŸ“Š Setup production monitoring
        if: needs.deploy-production.result == 'success'
        run: |
          echo "ğŸ“Š Configurando monitoreo continuo de producciÃ³n:"
          echo "  - Health checks: Cada minuto"
          echo "  - Performance monitoring: Continuo"
          echo "  - Error tracking: Tiempo real"
          echo "  - Log aggregation: Configurado"
          echo "  - Backup schedule: Diario a 02:00 AM"
          echo "  - Artifact retention: 90 dÃ­as"
          echo "  - Security monitoring: Activo"
          echo "âœ… Monitoreo de producciÃ³n activado"
          
      - name: ğŸ§¹ Production maintenance schedule
        run: |
          echo "ğŸ§¹ Programando mantenimiento de producciÃ³n:"
          echo "  - Performance review: Semanal"
          echo "  - Security audit: Mensual"
          echo "  - Dependency updates: Trimestral"
          echo "  - Disaster recovery test: Semestral"
          echo "âœ… Cronograma de mantenimiento configurado"
