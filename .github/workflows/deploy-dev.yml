# Pipeline por Entorno: Development
# Workflow especÃ­fico para el entorno de desarrollo
# Trigger: Push a rama 'dev' o 'development'

name: ğŸ‘· Deploy to Development

# Triggers especÃ­ficos para desarrollo
on:
  push:
    branches:
      - dev
      - development
      - develop  # Por compatibilidad
  
  # Trigger manual para testing
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Forzar deploy (skip tests)'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'Modo debug (logs detallados)'
        required: false
        default: false
        type: boolean

# Variables especÃ­ficas del entorno Development
env:
  ENVIRONMENT: 'development'
  NODE_ENV: 'development'
  PYTHON_VERSION: '3.9'
  DEBUG: 'true'
  LOG_LEVEL: 'debug'
  
  # URLs especÃ­ficas de desarrollo
  API_URL: 'https://dev-api.calculadora.example.com'
  WEB_URL: 'https://dev.calculadora.example.com'
  DATABASE_URL: 'postgresql://dev-db.example.com/calculadora_dev'
  
  # Configuraciones de desarrollo
  CACHE_TTL: '60'  # 1 minuto para desarrollo
  RATE_LIMIT: '1000'  # LÃ­mite alto para desarrollo
  SSL_REQUIRED: 'false'
  
jobs:
  # ===============================================
  # JOB 1: VALIDACIÃ“N Y BUILD PARA DESARROLLO
  # ===============================================
  build-dev:
    name: ğŸ”¨ Build for Development
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # Instalar dependencias adicionales para desarrollo
          pip install pytest pytest-cov black flake8 bandit
          
      - name: ğŸ§  Code quality checks (Development)
        if: ${{ !inputs.force_deploy }}
        run: |
          echo "ğŸ§  Ejecutando checks de calidad para desarrollo..."
          
          # Formateo de cÃ³digo
          echo "  â–¶ Verificando formato con black..."
          black --check --diff calculadora.py test_calculadora.py || echo "âš ï¸ Formato no estÃ¡ndar (permitido en dev)"
          
          # Linting
          echo "  â–¶ Ejecutando linting con flake8..."
          flake8 calculadora.py test_calculadora.py --max-line-length=100 || echo "âš ï¸ Issues de linting (permitido en dev)"
          
          # AnÃ¡lisis de seguridad bÃ¡sico
          echo "  â–¶ AnÃ¡lisis de seguridad con bandit..."
          bandit -r . -f json || echo "âš ï¸ Issues de seguridad menores (revisar en staging)"
          
      - name: ğŸ§ª Tests unitarios (Modo desarrollo)
        if: ${{ !inputs.force_deploy }}
        run: |
          echo "ğŸ§ª Ejecutando tests en modo desarrollo..."
          
          # Tests con coverage pero menos estricto
          pytest test_calculadora.py -v --cov=calculadora --cov-report=term-missing --cov-fail-under=70
          
          echo "âœ… Tests de desarrollo completados"
          
      - name: ğŸ“Š Generate development build
        run: |
          echo "ğŸ“Š Generando build para desarrollo..."
          
          mkdir -p dist-dev
          
          # Crear configuraciÃ³n especÃ­fica de desarrollo
          cat > dist-dev/config.py << 'EOF'
          # ConfiguraciÃ³n especÃ­fica de Development
          import os
          
          class DevelopmentConfig:
              DEBUG = True
              TESTING = False
              LOG_LEVEL = 'DEBUG'
              
              # URLs de desarrollo
              API_URL = '${{ env.API_URL }}'
              WEB_URL = '${{ env.WEB_URL }}'
              DATABASE_URL = '${{ env.DATABASE_URL }}'
              
              # Configuraciones relajadas para desarrollo
              CACHE_TTL = ${{ env.CACHE_TTL }}
              RATE_LIMIT = ${{ env.RATE_LIMIT }}
              SSL_REQUIRED = ${{ env.SSL_REQUIRED }}
              
              # Feature flags para desarrollo
              ENABLE_DEBUG_TOOLBAR = True
              ENABLE_PROFILING = True
              ALLOW_CORS = True
              
          config = DevelopmentConfig()
          EOF
          
          # Copiar archivos de aplicaciÃ³n
          cp calculadora.py dist-dev/
          cp requirements.txt dist-dev/
          
          # Crear archivo de informaciÃ³n de build
          cat > dist-dev/build-info.json << EOF
          {
            "environment": "${{ env.ENVIRONMENT }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "build_time": "$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")",
            "build_number": "${{ github.run_number }}",
            "urls": {
              "api": "${{ env.API_URL }}",
              "web": "${{ env.WEB_URL }}"
            },
            "debug_mode": ${{ inputs.debug_mode || false }}
          }
          EOF
          
      - name: ğŸ“¤ Upload development artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculadora-dev-${{ github.run_number }}
          path: dist-dev/
          retention-days: 3  # Menor retenciÃ³n para desarrollo
          
    outputs:
      artifact-name: calculadora-dev-${{ github.run_number }}
      build-url: ${{ env.WEB_URL }}
      
  # ===============================================
  # JOB 2: DEPLOY AL ENTORNO DE DESARROLLO
  # ===============================================
  deploy-development:
    name: ğŸš€ Deploy to Development Environment
    runs-on: ubuntu-latest
    needs: build-dev
    environment:
      name: development
      url: ${{ env.WEB_URL }}
    
    steps:
      - name: ğŸ“¥ Download development artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-dev.outputs.artifact-name }}
          path: ./deploy-dev
          
      - name: ğŸ” Verify development artifact
        run: |
          echo "ğŸ” Verificando artifact de desarrollo..."
          ls -la ./deploy-dev
          
          echo "ğŸ“„ Build info:"
          cat ./deploy-dev/build-info.json
          
          echo "âš™ï¸ ConfiguraciÃ³n de desarrollo:"
          head -20 ./deploy-dev/config.py
          
      - name: ğŸŒ Setup development environment
        run: |
          echo "ğŸŒ Configurando entorno de desarrollo..."
          
          # Simular configuraciÃ³n de desarrollo
          echo "  â–¶ Configurando variables de entorno..."
          echo "ENVIRONMENT=${{ env.ENVIRONMENT }}" >> $GITHUB_ENV
          echo "DEBUG=${{ env.DEBUG }}" >> $GITHUB_ENV
          echo "LOG_LEVEL=${{ env.LOG_LEVEL }}" >> $GITHUB_ENV
          
          echo "  â–¶ Preparando servicios de desarrollo..."
          echo "    - Base de datos: ${{ env.DATABASE_URL }}"
          echo "    - API: ${{ env.API_URL }}"
          echo "    - Cache TTL: ${{ env.CACHE_TTL }}s"
          
          echo "âœ… Entorno de desarrollo configurado"
          
      - name: ğŸ§ª Smoke tests en desarrollo
        run: |
          echo "ğŸ§ª Ejecutando smoke tests en desarrollo..."
          cd ./deploy-dev
          
          # Tests bÃ¡sicos con configuraciÃ³n de desarrollo
          python -c "
          import sys
          sys.path.append('.')
          
          from calculadora import Calculadora
          from config import config
          
          # Verificar configuraciÃ³n
          print(f'ğŸŒ Entorno: {config.DEBUG and \"DEBUG\" or \"PRODUCTION\"}')
          print(f'ğŸ”— API URL: {config.API_URL}')
          print(f'ğŸ“Š Cache TTL: {config.CACHE_TTL}s')
          
          # Tests funcionales bÃ¡sicos
          calc = Calculadora()
          
          assert calc.sumar(2, 3) == 5, 'Error en suma'
          assert calc.restar(10, 4) == 6, 'Error en resta'
          assert calc.multiplicar(3, 4) == 12, 'Error en multiplicaciÃ³n'
          assert calc.dividir(15, 3) == 5.0, 'Error en divisiÃ³n'
          
          print('âœ… Smoke tests de desarrollo pasaron')
          "
          
      - name: ğŸš€ Deploy to Development
        run: |
          echo "ğŸš€ Desplegando en entorno de DESARROLLO..."
          
          # Simular deployment especÃ­fico para desarrollo
          echo "  ğŸ“ˆ Deployment config:"
          echo "    - Environment: ${{ env.ENVIRONMENT }}"
          echo "    - Debug Mode: ${{ env.DEBUG }}"
          echo "    - URL: ${{ env.WEB_URL }}"
          echo "    - Build: ${{ needs.build-dev.outputs.artifact-name }}"
          
          # Deployment rÃ¡pido para desarrollo (sin downtime concerns)
          echo "  â–¶ Parando servicios anteriores..."
          sleep 1
          
          echo "  â–¶ Desplegando nueva versiÃ³n..."
          sleep 2
          
          echo "  â–¶ Iniciando servicios..."
          sleep 1
          
          echo "  â–¶ Configurando hot-reload para desarrollo..."
          sleep 1
          
          echo "âœ… Deploy a desarrollo completado"
          echo "ğŸ“Š MÃ©tricas de deployment:"
          echo "  - Tiempo total: ~5 segundos"
          echo "  - Downtime: ~1 segundo (aceptable en dev)"
          echo "  - Hot-reload: Habilitado"
          
      - name: ğŸ“ Update development status
        run: |
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "deployment_url=${{ env.WEB_URL }}" >> $GITHUB_OUTPUT
          echo "environment=development" >> $GITHUB_OUTPUT
          
  # ===============================================
  # JOB 3: POST-DEPLOYMENT PARA DESARROLLO
  # ===============================================
  post-deploy-dev:
    name: ğŸ“Š Post-Deployment Development
    runs-on: ubuntu-latest
    needs: [build-dev, deploy-development]
    if: always()
    
    steps:
      - name: ğŸ“Š Development metrics
        run: |
          echo "ğŸ“Š MÃ©tricas del deployment de desarrollo:"
          echo "  ğŸŒ Environment: development"
          echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "  ğŸ“¦ Artifact: ${{ needs.build-dev.outputs.artifact-name }}"
          echo "  ğŸ”— URL: ${{ needs.build-dev.outputs.build-url }}"
          echo "  â±ï¸ Deploy time: $(date '+%H:%M:%S')"
          echo "  ğŸ“Š Status: ${{ needs.deploy-development.result }}"
          
      - name: ğŸ“§ Development notification
        if: always()
        run: |
          if [[ "${{ needs.deploy-development.result }}" == "success" ]]; then
            echo "âœ… ğŸ“§ DESARROLLO - Deploy exitoso"
            echo "  ğŸ”— URL: ${{ needs.build-dev.outputs.build-url }}"
            echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
            echo "  ğŸ‘¤ Deployer: ${{ github.actor }}"
          else
            echo "âŒ ğŸ“§ DESARROLLO - Deploy fallÃ³"
            echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
            echo "  ğŸ‘¤ Deployer: ${{ github.actor }}"
            echo "  ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          # En un entorno real, esto serÃ­a una notificaciÃ³n a Slack/Teams especÃ­fica para desarrollo
          echo "ğŸ“§ NotificaciÃ³n de desarrollo enviada"
          
      - name: ğŸ§¹ Development cleanup
        run: |
          echo "ğŸ§¹ Limpieza especÃ­fica de desarrollo:"
          echo "  - Artifacts: RetenciÃ³n 3 dÃ­as"
          echo "  - Logs: Nivel DEBUG habilitado"
          echo "  - Cache: TTL corto para development"
          echo "âœ… Limpieza de desarrollo completada"
