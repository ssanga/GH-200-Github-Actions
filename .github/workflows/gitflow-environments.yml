# Workflow GitFlow - Entornos AutomÃ¡ticos
# Este workflow implementa la estrategia GitFlow con despliegues automÃ¡ticos a diferentes entornos

name: ğŸ”„ GitFlow Environments

# Triggers para diferentes ramas
on:
  push:
    branches:
      - main          # ProducciÃ³n
      - develop       # Staging/Development
      - 'feature/**'  # Features temporales
      - 'release/**'  # Pre-producciÃ³n
      - 'hotfix/**'   # Hotfixes urgentes
  
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

  # Para releases manuales
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno destino'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Forzar despliegue (skip tests)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.9'
  ARTIFACT_NAME: 'calculadora-app'
  
jobs:
  # ===============================================
  # JOB 1: BUILD - Construir aplicaciÃ³n una vez
  # ===============================================
  build:
    name: ğŸ”¨ Build Application
    runs-on: ubuntu-latest
    
    # Solo ejecutar build en pushes o PRs especÃ­ficos
    if: >
      github.event_name == 'push' || 
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ§ª Run unit tests
        if: ${{ !inputs.force_deploy }}
        run: |
          python -m unittest test_calculadora.py -v
          
      - name: ğŸ“Š Generate coverage report
        if: ${{ !inputs.force_deploy }}
        run: |
          pip install coverage
          coverage run -m unittest test_calculadora.py
          coverage report --show-missing
          coverage html
          
      - name: ğŸ“„ Create build info
        run: |
          mkdir -p dist
          echo "Build Info:" > dist/build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> dist/build-info.txt
          echo "Commit: ${{ github.sha }}" >> dist/build-info.txt
          echo "Build Time: $(date)" >> dist/build-info.txt
          echo "Event: ${{ github.event_name }}" >> dist/build-info.txt
          
          # Copiar archivos de aplicaciÃ³n
          cp calculadora.py dist/
          cp requirements.txt dist/
          
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.run_number }}
          path: dist/
          retention-days: 7
          
    outputs:
      artifact-name: ${{ env.ARTIFACT_NAME }}-${{ github.run_number }}
      branch-name: ${{ github.ref_name }}
      
  # ===============================================
  # JOB 2: STAGING - Deploy a staging (develop)
  # ===============================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    environment: 
      name: staging
      url: https://staging.calculadora.example.com
    
    # Solo para develop branch o workflow_dispatch a staging
    if: >
      github.ref == 'refs/heads/develop' ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging')
    
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./deploy
          
      - name: ğŸ” Verify artifact
        run: |
          echo "ğŸ“‚ Contenido del artifact:"
          ls -la ./deploy
          echo "ğŸ“„ Build info:"
          cat ./deploy/build-info.txt
          
      - name: ğŸ§ª Smoke tests en staging
        run: |
          echo "ğŸ§ª Ejecutando smoke tests en staging..."
          cd ./deploy
          python -c "from calculadora import Calculadora; calc = Calculadora(); print(f'Test suma: {calc.sumar(2, 2)}')"
          echo "âœ… Smoke tests pasados"
          
      - name: ğŸš€ Deploy to Staging Environment
        run: |
          echo "ğŸš€ Desplegando en STAGING..."
          echo "ğŸ“¦ Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "ğŸŒ¿ Branch: ${{ needs.build.outputs.branch-name }}"
          echo "ğŸ”— URL: https://staging.calculadora.example.com"
          echo "âœ… Deploy completado en staging"
          
      - name: ğŸ“ Update deployment status
        run: |
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "deployment_url=https://staging.calculadora.example.com" >> $GITHUB_OUTPUT
          
  # ===============================================
  # JOB 3: PRODUCTION - Deploy a producciÃ³n (main)
  # ===============================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment: 
      name: production
      url: https://calculadora.example.com
    
    # Solo para main branch, releases, hotfixes o workflow_dispatch a production
    if: >
      github.ref == 'refs/heads/main' ||
      startsWith(github.ref, 'refs/heads/release/') ||
      startsWith(github.ref, 'refs/heads/hotfix/') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./deploy
          
      - name: ğŸ” Verify artifact
        run: |
          echo "ğŸ“‚ Contenido del artifact:"
          ls -la ./deploy
          echo "ğŸ“„ Build info:"
          cat ./deploy/build-info.txt
          
      - name: ğŸ§ª Extended tests en production
        run: |
          echo "ğŸ§ª Ejecutando tests extendidos en producciÃ³n..."
          cd ./deploy
          python -c "
          from calculadora import Calculadora
          calc = Calculadora()
          
          # Tests crÃ­ticos
          assert calc.sumar(2, 2) == 4
          assert calc.restar(5, 3) == 2
          assert calc.multiplicar(3, 4) == 12
          assert calc.dividir(10, 2) == 5.0
          
          print('âœ… Todos los tests crÃ­ticos pasaron')
          "
          
      - name: ğŸš€ Deploy to Production Environment
        run: |
          echo "ğŸŒŸ Desplegando en PRODUCCIÃ“N..."
          echo "ğŸ“¦ Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "ğŸŒ¿ Branch: ${{ needs.build.outputs.branch-name }}"
          echo "ğŸ”— URL: https://calculadora.example.com"
          
          # Simular backup antes del deploy
          echo "ğŸ’¾ Creando backup de la versiÃ³n actual..."
          sleep 2
          
          # Simular deploy gradual
          echo "ğŸ“ˆ Desplegando gradualmente..."
          echo "  â–¶ 10% del trÃ¡fico..."
          sleep 1
          echo "  â–¶ 50% del trÃ¡fico..."
          sleep 1
          echo "  â–¶ 100% del trÃ¡fico..."
          
          echo "âœ… Deploy completado en producciÃ³n"
          
  # ===============================================
  # JOB 4: FEATURE - Testing para feature branches
  # ===============================================
  test-feature:
    name: ğŸ§ª Test Feature Branch
    runs-on: ubuntu-latest
    needs: build
    
    # Solo para feature branches
    if: startsWith(github.ref, 'refs/heads/feature/')
    
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./test
          
      - name: ğŸ§ª Feature testing
        run: |
          echo "ğŸ§ª Probando feature branch: ${{ needs.build.outputs.branch-name }}"
          cd ./test
          
          # Tests especÃ­ficos para features
          python -c "
          from calculadora import Calculadora
          calc = Calculadora()
          
          print('ğŸ§® Probando funcionalidades bÃ¡sicas:')
          print(f'  Suma: 2 + 3 = {calc.sumar(2, 3)}')
          print(f'  Resta: 10 - 4 = {calc.restar(10, 4)}')
          print(f'  MultiplicaciÃ³n: 5 * 6 = {calc.multiplicar(5, 6)}')
          print(f'  DivisiÃ³n: 15 / 3 = {calc.dividir(15, 3)}')
          
          print('âœ… Feature tests completados')
          "
          
      - name: ğŸ“Š Feature metrics
        run: |
          echo "ğŸ“Š MÃ©tricas de la feature:"
          echo "  ğŸŒ¿ Branch: ${{ needs.build.outputs.branch-name }}"
          echo "  ğŸ“¦ Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "  â±ï¸ Test duration: $(date '+%T')"
          echo "  âœ… Status: Passed"
          
  # ===============================================
  # JOB 5: NOTIFICATION - Notificaciones de estado
  # ===============================================
  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build, deploy-staging, deploy-production, test-feature]
    if: always()  # Ejecutar siempre, independientemente del resultado
    
    steps:
      - name: ğŸ“Š Determine overall status
        id: status
        run: |
          echo "ğŸ“Š Analizando estado general del workflow..."
          
          # Verificar estado de jobs
          BUILD_STATUS="${{ needs.build.result }}"
          STAGING_STATUS="${{ needs.deploy-staging.result }}"
          PRODUCTION_STATUS="${{ needs.deploy-production.result }}"
          FEATURE_STATUS="${{ needs.test-feature.result }}"
          
          echo "ğŸ” Estados de jobs:"
          echo "  ğŸ“¦ Build: $BUILD_STATUS"
          echo "  ğŸš€ Staging: $STAGING_STATUS"
          echo "  ğŸŒŸ Production: $PRODUCTION_STATUS"
          echo "  ğŸ§ª Feature: $FEATURE_STATUS"
          
          # Determinar estado general
          if [[ "$BUILD_STATUS" == "failure" ]]; then
            echo "âŒ Build fallÃ³ - Workflow failed"
            echo "overall_status=failed" >> $GITHUB_OUTPUT
          elif [[ "$STAGING_STATUS" == "failure" || "$PRODUCTION_STATUS" == "failure" ]]; then
            echo "âš ï¸ Deploy fallÃ³ - Partial failure"
            echo "overall_status=partial" >> $GITHUB_OUTPUT
          else
            echo "âœ… Workflow completado exitosamente"
            echo "overall_status=success" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“¢ Send notification
        run: |
          echo "ğŸ“¢ Enviando notificaciÃ³n..."
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ’¾ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“Š Status: ${{ steps.status.outputs.overall_status }}"
          echo "ğŸ”— Workflow URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # En un entorno real, aquÃ­ enviarÃ­as a Slack, Teams, etc.
          echo "ğŸ“§ NotificaciÃ³n enviada (simulada)"
          
  # ===============================================
  # JOB 6: CLEANUP - Limpieza de artifacts
  # ===============================================
  cleanup:
    name: ğŸ§¹ Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()  # Siempre ejecutar limpieza
    
    steps:
      - name: ğŸ§¹ Artifact cleanup info
        run: |
          echo "ğŸ§¹ InformaciÃ³n de limpieza de artifacts:"
          echo "ğŸ“¦ Artifact name: ${{ needs.build.outputs.artifact-name || 'N/A' }}"
          echo "â° Retention: 7 dÃ­as"
          echo "ğŸ—‘ï¸ Auto-cleanup: Habilitado"
          echo "âœ… Limpieza programada"
