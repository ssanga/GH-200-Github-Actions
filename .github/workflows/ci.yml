name: CI - Tests y Cobertura

# Triggers: cuando hay push a development o PR hacia main
on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Tests Unitarios y Cobertura
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ“‹ InformaciÃ³n del Commit y Contexto
      run: |
        echo "ğŸš€ === INFORMACIÃ“N DEL WORKFLOW ==="
        echo "ğŸ“… Fecha y hora: $(date)"
        echo "ğŸƒ Runner: ${{ runner.os }} - ${{ runner.arch }}"
        echo "ğŸ Python version: ${{ matrix.python-version }}"
        echo ""
        echo "ğŸ“ === INFORMACIÃ“N DEL COMMIT ==="
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        echo "ğŸ“§ Email del commit: ${{ github.event.head_commit.author.email }}"
        echo "ğŸ†” SHA del commit: ${{ github.sha }}"
        echo "ğŸ”— SHA corto: ${{ github.sha }}" | cut -c1-8
        echo "ğŸ’¬ Mensaje: ${{ github.event.head_commit.message }}"
        echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "ğŸ“¦ Repositorio: ${{ github.repository }}"
        echo ""
        echo "ğŸ”„ === INFORMACIÃ“N DEL EVENTO ==="
        echo "ğŸ¯ Evento: ${{ github.event_name }}"
        echo "ğŸ”¢ NÃºmero de ejecuciÃ³n: ${{ github.run_number }}"
        echo "ğŸ†” ID de ejecuciÃ³n: ${{ github.run_id }}"
        echo "ğŸ”„ Intento: ${{ github.run_attempt }}"
        echo ""
        echo "ğŸ”— === ENLACES ÃšTILES ==="
        echo "ğŸ“Š Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ğŸ“ Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
        echo ""
        echo "ğŸŒ === VARIABLES DE ENTORNO ==="
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
        echo "GITHUB_ACTION: $GITHUB_ACTION"
        echo "GITHUB_WORKFLOW: $GITHUB_WORKFLOW"
    
    - name: Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache dependencias pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage
    
    - name: Ejecutar linting con flake8
      run: |
        # Detener el build si hay errores de sintaxis o nombres indefinidos
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Advertencias por complejidad y estilo (no detiene el build)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Ejecutar tests con cobertura
      run: |
        coverage run -m unittest discover -s . -p "test_*.py" -v
        coverage report -m
        coverage xml
    
    - name: Subir cobertura a Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Generar reporte HTML de cobertura
      run: |
        coverage html
    
    - name: Subir artefactos de cobertura
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 30
    
    - name: Verificar cobertura mÃ­nima
      run: |
        coverage report --fail-under=90
    
    - name: ğŸ“Š Resumen Final del CI
      if: always()
      run: |
        echo "âœ… === RESUMEN DE EJECUCIÃ“N ==="
        echo "ğŸ Python ${{ matrix.python-version }} - Completado"
        echo "ğŸ‘¤ Ejecutado por: ${{ github.actor }}"
        echo "ğŸ†” Commit: ${{ github.sha }}" | cut -c1-8
        echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "â±ï¸ Workflow: ${{ github.workflow }}"
        echo "ğŸ”¢ EjecuciÃ³n #${{ github.run_number }}"
        echo ""
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Estado: Ã‰XITO âœ…"
        else
          echo "âŒ Estado: FALLO âŒ"
        fi
        echo ""
        echo "ğŸ“ˆ PrÃ³ximos pasos:"
        echo "- Revisar artefactos de cobertura"
        echo "- Verificar reportes de Codecov"
        echo "- Continuar con el desarrollo"