name: ðŸš€ Build Once Deploy Many

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_to_production:
        description: 'Desplegar tambiÃ©n a Production'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: ðŸ”¨ Build y Test
    runs-on: ubuntu-latest
    
    outputs:
      artifact-name: ${{ steps.build.outputs.artifact-name }}
      version: ${{ steps.version.outputs.version }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ“‹ InformaciÃ³n del Build
      run: |
        echo "ðŸ”¨ === BUILD ONCE DEPLOY MANY ==="
        echo "ðŸ‘¤ Autor: ${{ github.actor }}"
        echo "ðŸ†” Commit: ${{ github.sha }}" | cut -c1-8
        echo "ðŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "ðŸ“… Fecha: $(date -Iseconds)"
        echo "ðŸŽ¯ Evento: ${{ github.event_name }}"
    
    - name: ðŸ·ï¸ Determinar VersiÃ³n
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          # Limpiar el nombre de la rama para evitar caracteres invÃ¡lidos
          CLEAN_BRANCH=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          VERSION="${CLEAN_BRANCH}-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ VersiÃ³n: $VERSION"
    
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Cache dependencias
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ðŸ”§ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage
    
    - name: ðŸ§ª Ejecutar Tests Completos
      run: |
        echo "ðŸ§ª Ejecutando suite completa de tests..."
        
        # Linting
        echo "ðŸ” Linting con flake8..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
        # Tests unitarios con cobertura
        echo "ðŸ§ª Tests unitarios con cobertura..."
        coverage run -m unittest discover -s . -p "test_*.py" -v
        coverage report -m
        coverage report --fail-under=90
        
        # Generar reporte XML para artefactos
        coverage xml
        coverage html
        
        echo "âœ… Todos los tests pasaron"
    
    - name: ðŸ“¦ Build de la AplicaciÃ³n
      id: build
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        # Limpiar el nombre del artefacto para evitar caracteres invÃ¡lidos
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/[^a-zA-Z0-9._-]/-/g')
        ARTIFACT_NAME="calculadora-$CLEAN_VERSION"
        
        echo "ðŸ”¨ Construyendo aplicaciÃ³n: $ARTIFACT_NAME"
        
        # Crear directorio de build
        mkdir -p "build/$ARTIFACT_NAME"
        
        # Copiar archivos de la aplicaciÃ³n
        cp calculadora.py "build/$ARTIFACT_NAME/"
        cp requirements.txt "build/$ARTIFACT_NAME/"
        cp README.md "build/$ARTIFACT_NAME/"
        
        # Crear archivo de metadatos del build
        cat > "build/$ARTIFACT_NAME/build-info.json" << EOF
        {
          "version": "$VERSION",
          "build_date": "$(date -Iseconds)",
          "commit_sha": "${{ github.sha }}",
          "commit_short": "$(git rev-parse --short HEAD)",
          "branch": "${{ github.ref_name }}",
          "built_by": "${{ github.actor }}",
          "workflow_run": "${{ github.run_number }}",
          "repository": "${{ github.repository }}",
          "event": "${{ github.event_name }}"
        }
        EOF
        
        # Crear script de inicio
        cat > "build/$ARTIFACT_NAME/start.sh" << 'EOF'
        #!/bin/bash
        echo "ðŸš€ === CALCULADORA INICIANDO ==="
        echo "ðŸ“‹ InformaciÃ³n del build:"
        cat build-info.json | python -m json.tool
        echo ""
        echo "ðŸ”§ Variables de entorno:"
        env | grep -E "(ENVIRONMENT|DEPLOYED)" | sort
        echo ""
        echo "ðŸ§® Ejecutando calculadora..."
        python calculadora.py
        EOF
        chmod +x "build/$ARTIFACT_NAME/start.sh"
        
        # Crear archivo ZIP del artefacto
        cd build
        zip -r "$ARTIFACT_NAME.zip" "$ARTIFACT_NAME/"
        cd ..
        
        echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
        echo "âœ… Artefacto creado: $ARTIFACT_NAME.zip"
        
        # Mostrar contenido
        echo "ðŸ“ Contenido del artefacto:"
        ls -la "build/$ARTIFACT_NAME/"
    
    - name: ðŸŽ¯ Determinar Despliegues
      id: deploy-check
      run: |
        SHOULD_DEPLOY="false"
        
        # Desplegar si es push a main o development (no en PR)
        if [ "${{ github.event_name }}" == "push" ]; then
          SHOULD_DEPLOY="true"
        fi
        
        # Desplegar si es workflow_dispatch
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          SHOULD_DEPLOY="true"
        fi
        
        echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Debe desplegar: $SHOULD_DEPLOY"
    
    - name: ðŸ“¤ Subir Artefacto de Build
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build.outputs.artifact-name }}
        path: build/${{ steps.build.outputs.artifact-name }}.zip
        retention-days: 90
    
    - name: ðŸ“¤ Subir Reportes de Cobertura
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports-${{ github.run_number }}
        path: |
          coverage.xml
          htmlcov/
        retention-days: 30

  deploy-development:
    name: ðŸ› ï¸ Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.should-deploy == 'true' && (github.ref == 'refs/heads/development' || github.event_name == 'workflow_dispatch')
    environment: 
      name: development
      url: https://dev.calculadora-app.com
    
    steps:
    - name: ðŸ“‹ Info Despliegue Development
      run: |
        echo "ðŸ› ï¸ === DESPLIEGUE A DEVELOPMENT ==="
        echo "ðŸ“¦ Artefacto: ${{ needs.build.outputs.artifact-name }}"
        echo "ðŸ·ï¸ VersiÃ³n: ${{ needs.build.outputs.version }}"
        echo "ðŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ðŸ“… Fecha: $(date -Iseconds)"
    
    - name: ðŸ“¥ Descargar Artefacto
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build.outputs.artifact-name }}
        path: ./artifacts
    
    - name: ðŸ“¦ Preparar para Development
      run: |
        cd artifacts
        unzip -q *.zip
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸ“¦ Preparando para Development..."
        echo "ðŸ“‚ Directorio: $ARTIFACT_DIR"
        
        # Configurar variables de entorno para development
        cat > "$ARTIFACT_DIR/.env" << EOF
        ENVIRONMENT=development
        DEPLOYED_AT=$(date -Iseconds)
        DEPLOYED_BY=${{ github.actor }}
        DEPLOYMENT_RUN_ID=${{ github.run_id }}
        LOG_LEVEL=DEBUG
        DEBUG=true
        MONITORING=false
        EOF
        
        echo "âœ… ConfiguraciÃ³n de Development aplicada"
    
    - name: ðŸš€ Desplegar a Development
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸš€ Desplegando a Development..."
        echo "ðŸ“ Contenido:"
        ls -la "$ARTIFACT_DIR/"
        echo ""
        echo "ðŸ”§ ConfiguraciÃ³n:"
        cat "$ARTIFACT_DIR/.env"
        echo ""
        echo "ðŸŒ Simulando despliegue a Development..."
        sleep 2
        echo "âœ… Desplegado en: https://dev.calculadora-app.com"
    
    - name: ðŸ§ª Tests Post-Despliegue
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        cd "$ARTIFACT_DIR"
        
        echo "ðŸ§ª Tests de humo en Development..."
        python calculadora.py
        echo "âœ… Tests de humo OK"

  deploy-staging:
    name: ðŸŽ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.should-deploy == 'true' && github.ref == 'refs/heads/main'
    environment: 
      name: staging
      url: https://staging.calculadora-app.com
    
    steps:
    - name: ðŸ“‹ Info Despliegue Staging
      run: |
        echo "ðŸŽ­ === DESPLIEGUE A STAGING ==="
        echo "ðŸ“¦ Artefacto: ${{ needs.build.outputs.artifact-name }}"
        echo "ðŸ·ï¸ VersiÃ³n: ${{ needs.build.outputs.version }}"
        echo "ðŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ðŸ“… Fecha: $(date -Iseconds)"
    
    - name: ðŸ“¥ Descargar Artefacto
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build.outputs.artifact-name }}
        path: ./artifacts
    
    - name: ðŸ“¦ Preparar para Staging
      run: |
        cd artifacts
        unzip -q *.zip
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸ“¦ Preparando para Staging..."
        
        # Configurar variables de entorno para staging
        cat > "$ARTIFACT_DIR/.env" << EOF
        ENVIRONMENT=staging
        DEPLOYED_AT=$(date -Iseconds)
        DEPLOYED_BY=${{ github.actor }}
        DEPLOYMENT_RUN_ID=${{ github.run_id }}
        LOG_LEVEL=INFO
        DEBUG=false
        MONITORING=true
        EOF
        
        echo "âœ… ConfiguraciÃ³n de Staging aplicada"
    
    - name: ðŸš€ Desplegar a Staging
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸš€ Desplegando a Staging..."
        echo "ðŸ“ Contenido:"
        ls -la "$ARTIFACT_DIR/"
        echo ""
        echo "ðŸ”§ ConfiguraciÃ³n:"
        cat "$ARTIFACT_DIR/.env"
        echo ""
        echo "ðŸŒ Simulando despliegue a Staging..."
        sleep 3
        echo "âœ… Desplegado en: https://staging.calculadora-app.com"
    
    - name: ðŸ§ª Tests de IntegraciÃ³n
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        cd "$ARTIFACT_DIR"
        
        echo "ðŸ§ª Tests de integraciÃ³n en Staging..."
        python calculadora.py
        echo "ðŸ” Verificando configuraciÃ³n de staging..."
        echo "âœ… Tests de integraciÃ³n OK"

  deploy-production:
    name: ðŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: needs.build.outputs.should-deploy == 'true' && (github.ref == 'refs/heads/main' && inputs.deploy_to_production == true)
    environment: 
      name: production
      url: https://calculadora-app.com
    
    steps:
    - name: ðŸ“‹ Info Despliegue Production
      run: |
        echo "ðŸ­ === DESPLIEGUE A PRODUCTION ==="
        echo "ðŸ“¦ Artefacto: ${{ needs.build.outputs.artifact-name }}"
        echo "ðŸ·ï¸ VersiÃ³n: ${{ needs.build.outputs.version }}"
        echo "ðŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ðŸ“… Fecha: $(date -Iseconds)"
        echo "âš ï¸ DESPLIEGUE CRÃTICO A PRODUCCIÃ“N"
    
    - name: ðŸ“¥ Descargar Artefacto
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build.outputs.artifact-name }}
        path: ./artifacts
    
    - name: ðŸ”’ Validaciones CrÃ­ticas
      run: |
        cd artifacts
        unzip -q *.zip
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸ”’ Validaciones crÃ­ticas para Production..."
        
        # Verificar integridad del artefacto
        if [ ! -f "$ARTIFACT_DIR/calculadora.py" ]; then
          echo "âŒ Archivo principal no encontrado"
          exit 1
        fi
        
        if [ ! -f "$ARTIFACT_DIR/build-info.json" ]; then
          echo "âŒ InformaciÃ³n de build no encontrada"
          exit 1
        fi
        
        echo "âœ… Validaciones crÃ­ticas OK"
    
    - name: ðŸ“¦ Preparar para Production
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸ“¦ Preparando para Production..."
        
        # Configurar variables de entorno para production
        cat > "$ARTIFACT_DIR/.env" << EOF
        ENVIRONMENT=production
        DEPLOYED_AT=$(date -Iseconds)
        DEPLOYED_BY=${{ github.actor }}
        DEPLOYMENT_RUN_ID=${{ github.run_id }}
        LOG_LEVEL=ERROR
        DEBUG=false
        MONITORING=true
        HIGH_AVAILABILITY=true
        EOF
        
        echo "âœ… ConfiguraciÃ³n de Production aplicada"
    
    - name: ðŸš€ Desplegar a Production
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸš€ DESPLEGANDO A PRODUCTION..."
        echo "ðŸ“ Contenido:"
        ls -la "$ARTIFACT_DIR/"
        echo ""
        echo "ðŸ”§ ConfiguraciÃ³n:"
        cat "$ARTIFACT_DIR/.env"
        echo ""
        echo "ðŸ­ Simulando despliegue crÃ­tico a Production..."
        echo "  - Activando alta disponibilidad..."
        echo "  - Configurando balanceadores..."
        echo "  - Activando monitoreo avanzado..."
        sleep 5
        echo "âœ… DESPLEGADO EN PRODUCTION: https://calculadora-app.com"
    
    - name: ðŸ§ª Tests CrÃ­ticos de Production
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        cd "$ARTIFACT_DIR"
        
        echo "ðŸ§ª Tests crÃ­ticos de Production..."
        python calculadora.py
        echo "ðŸ” Verificando health checks..."
        echo "ðŸ“Š Verificando mÃ©tricas..."
        echo "âœ… Production OK - Sistema operativo"

  summary:
    name: ðŸ“Š Resumen de Despliegues
    runs-on: ubuntu-latest
    needs: [build, deploy-development, deploy-staging, deploy-production]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: ðŸ“Š Reporte Final
      run: |
        echo "ðŸŽ‰ === RESUMEN DE DESPLIEGUES ==="
        echo "ðŸ“¦ Artefacto: ${{ needs.build.outputs.artifact-name }}"
        echo "ðŸ·ï¸ VersiÃ³n: ${{ needs.build.outputs.version }}"
        echo "ðŸ‘¤ Por: ${{ github.actor }}"
        echo "ðŸ“… Completado: $(date -Iseconds)"
        echo ""
        echo "ðŸŽ¯ Estados de Despliegue:"
        echo "  ðŸ› ï¸ Development: ${{ needs.deploy-development.result || 'Skipped' }}"
        echo "  ðŸŽ­ Staging: ${{ needs.deploy-staging.result || 'Skipped' }}"
        echo "  ðŸ­ Production: ${{ needs.deploy-production.result || 'Skipped' }}"
        echo ""
        echo "ðŸ”— URLs Desplegadas:"
        if [ "${{ needs.deploy-development.result }}" == "success" ]; then
          echo "  ðŸ› ï¸ Development: https://dev.calculadora-app.com"
        fi
        if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "  ðŸŽ­ Staging: https://staging.calculadora-app.com"
        fi
        if [ "${{ needs.deploy-production.result }}" == "success" ]; then
          echo "  ðŸ­ Production: https://calculadora-app.com"
        fi