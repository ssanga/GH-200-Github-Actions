# Pipeline por Entorno: Staging
# Workflow especÃ­fico para el entorno de staging/pre-producciÃ³n
# Trigger: Push a rama 'staging' o workflow_dispatch

name: ğŸ† Deploy to Staging

# Triggers especÃ­ficos para staging
on:
  push:
    branches:
      - staging
      - stage
      - pre-production
  
  # Trigger manual para validaciÃ³n
  workflow_dispatch:
    inputs:
      run_performance_tests:
        description: 'Ejecutar tests de rendimiento'
        required: false
        default: true
        type: boolean
      notify_team:
        description: 'Notificar al equipo'
        required: false
        default: true
        type: boolean

# Variables especÃ­ficas del entorno Staging
env:
  ENVIRONMENT: 'staging'
  NODE_ENV: 'staging'
  PYTHON_VERSION: '3.9'
  DEBUG: 'false'
  LOG_LEVEL: 'info'
  
  # URLs especÃ­ficas de staging
  API_URL: 'https://staging-api.calculadora.example.com'
  WEB_URL: 'https://staging.calculadora.example.com'
  DATABASE_URL: 'postgresql://staging-db.example.com/calculadora_staging'
  
  # Configuraciones de staging (mÃ¡s restrictivas que dev)
  CACHE_TTL: '300'  # 5 minutos
  RATE_LIMIT: '500'  # LÃ­mite medio
  SSL_REQUIRED: 'true'
  
jobs:
  # ===============================================
  # JOB 1: BUILD Y VALIDACIÃ“N PARA STAGING
  # ===============================================
  build-staging:
    name: ğŸ—ï¸ Build for Staging
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # Instalar herramientas de testing y calidad
          pip install pytest pytest-cov pytest-benchmark black flake8 bandit safety
          
      - name: ğŸ”’ Security and dependency check
        run: |
          echo "ğŸ”’ Ejecutando checks de seguridad para staging..."
          
          # Check de vulnerabilidades en dependencias
          echo "  â–¶ Verificando vulnerabilidades en dependencias..."
          safety check --json || echo "âš ï¸ Vulnerabilidades encontradas (revisar)"
          
          # AnÃ¡lisis de seguridad del cÃ³digo
          echo "  â–¶ AnÃ¡lisis de seguridad del cÃ³digo..."
          bandit -r . -f json -o bandit-report.json || true
          cat bandit-report.json | head -50
          
      - name: ğŸ§  Code quality enforcement (Staging)
        run: |
          echo "ğŸ§  Aplicando estÃ¡ndares de calidad para staging..."
          
          # Formateo obligatorio
          echo "  â–¶ Verificando formato con black (OBLIGATORIO)..."
          black --check calculadora.py test_calculadora.py
          
          # Linting estricto
          echo "  â–¶ Linting estricto con flake8..."
          flake8 calculadora.py test_calculadora.py --max-line-length=88 --max-complexity=10
          
          echo "âœ… EstÃ¡ndares de calidad aplicados"
          
      - name: ğŸ§ª Tests completos (Staging)
        run: |
          echo "ğŸ§ª Ejecutando suite completa de tests para staging..."
          
          # Tests unitarios con coverage estricto
          pytest test_calculadora.py -v \
            --cov=calculadora \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-fail-under=90
          
          echo "âœ… Tests de staging completados"
          
      - name: ğŸ“Š Performance tests
        if: ${{ inputs.run_performance_tests != false }}
        run: |
          echo "ğŸ“Š Ejecutando tests de rendimiento..."
          
          # Tests de rendimiento bÃ¡sicos
          python -c "
          import time
          from calculadora import Calculadora
          
          calc = Calculadora()
          
          # Test de rendimiento simple
          start_time = time.time()
          for i in range(10000):
              calc.sumar(i, i+1)
              calc.multiplicar(i, 2)
          end_time = time.time()
          
          duration = end_time - start_time
          print(f'ğŸ“Š Rendimiento: 20,000 operaciones en {duration:.3f}s')
          
          if duration > 1.0:
              print('âš ï¸  Performance warning: Operaciones lentas')
          else:
              print('âœ… Performance: OK')
          "
          
      - name: ğŸ—ï¸ Generate staging build
        run: |
          echo "ğŸ—ï¸ Generando build para staging..."
          
          mkdir -p dist-staging
          
          # Crear configuraciÃ³n especÃ­fica de staging
          cat > dist-staging/config.py << 'EOF'
          # ConfiguraciÃ³n especÃ­fica de Staging
          import os
          
          class StagingConfig:
              DEBUG = False
              TESTING = True  # Ambiente de testing
              LOG_LEVEL = 'INFO'
              
              # URLs de staging
              API_URL = '${{ env.API_URL }}'
              WEB_URL = '${{ env.WEB_URL }}'
              DATABASE_URL = '${{ env.DATABASE_URL }}'
              
              # Configuraciones de staging
              CACHE_TTL = ${{ env.CACHE_TTL }}
              RATE_LIMIT = ${{ env.RATE_LIMIT }}
              SSL_REQUIRED = ${{ env.SSL_REQUIRED }}
              
              # Configuraciones de seguridad para staging
              SECURE_COOKIES = True
              SESSION_TIMEOUT = 3600  # 1 hora
              MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB
              
              # Feature flags para staging
              ENABLE_MONITORING = True
              ENABLE_METRICS = True
              ALLOW_CORS = False  # MÃ¡s restrictivo que dev
              
          config = StagingConfig()
          EOF
          
          # Copiar archivos de aplicaciÃ³n
          cp calculadora.py dist-staging/
          cp requirements.txt dist-staging/
          
          # Crear archivo de informaciÃ³n de build con mÃ¡s detalles
          cat > dist-staging/build-info.json << EOF
          {
            "environment": "${{ env.ENVIRONMENT }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "build_time": "$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")",
            "build_number": "${{ github.run_number }}",
            "version": "staging-${{ github.run_number }}",
            "urls": {
              "api": "${{ env.API_URL }}",
              "web": "${{ env.WEB_URL }}"
            },
            "security": {
              "ssl_required": ${{ env.SSL_REQUIRED }},
              "rate_limit": ${{ env.RATE_LIMIT }}
            },
            "quality_checks": {
              "code_format": "passed",
              "linting": "passed",
              "security_scan": "completed",
              "coverage": ">=90%"
            }
          }
          EOF
          
      - name: ğŸ“¤ Upload staging artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculadora-staging-${{ github.run_number }}
          path: dist-staging/
          retention-days: 14  # RetenciÃ³n media para staging
          
    outputs:
      artifact-name: calculadora-staging-${{ github.run_number }}
      build-url: ${{ env.WEB_URL }}
      
  # ===============================================
  # JOB 2: DEPLOY AL ENTORNO DE STAGING
  # ===============================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: build-staging
    environment:
      name: staging
      url: ${{ env.WEB_URL }}
    
    steps:
      - name: ğŸ“¥ Download staging artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-staging.outputs.artifact-name }}
          path: ./deploy-staging
          
      - name: ğŸ” Verify staging artifact
        run: |
          echo "ğŸ” Verificando artifact de staging..."
          ls -la ./deploy-staging
          
          echo "ğŸ“„ Build info detallada:"
          cat ./deploy-staging/build-info.json | jq .
          
          echo "âš™ï¸ ConfiguraciÃ³n de staging:"
          head -30 ./deploy-staging/config.py
          
      - name: ğŸ—ï¸ Setup staging environment
        run: |
          echo "ğŸ—ï¸ Configurando entorno de staging..."
          
          # ConfiguraciÃ³n mÃ¡s robusta para staging
          echo "  â–¶ Configurando variables de entorno seguras..."
          echo "ENVIRONMENT=${{ env.ENVIRONMENT }}" >> $GITHUB_ENV
          echo "DEBUG=${{ env.DEBUG }}" >> $GITHUB_ENV
          echo "LOG_LEVEL=${{ env.LOG_LEVEL }}" >> $GITHUB_ENV
          echo "SSL_REQUIRED=${{ env.SSL_REQUIRED }}" >> $GITHUB_ENV
          
          echo "  â–¶ Preparando servicios de staging..."
          echo "    - Base de datos: ${{ env.DATABASE_URL }}"
          echo "    - API (SSL): ${{ env.API_URL }}"
          echo "    - Cache TTL: ${{ env.CACHE_TTL }}s"
          echo "    - Rate Limit: ${{ env.RATE_LIMIT }} req/min"
          
          echo "  â–¶ Validando conectividad de servicios..."
          # Simular health checks
          sleep 2
          
          echo "âœ… Entorno de staging configurado y validado"
          
      - name: ğŸ§ª Integration tests en staging
        run: |
          echo "ğŸ§ª Ejecutando integration tests en staging..."
          cd ./deploy-staging
          
          # Tests de integraciÃ³n mÃ¡s completos
          python -c "
          import sys, json
          sys.path.append('.')
          
          from calculadora import Calculadora
          from config import config
          
          # Verificar configuraciÃ³n de staging
          print(f'ğŸ—ï¸ Entorno: {config.TESTING and \"STAGING\" or \"UNKNOWN\"}')
          print(f'ğŸ”’ SSL: {config.SSL_REQUIRED}')
          print(f'ğŸ“Š Rate Limit: {config.RATE_LIMIT}')
          print(f'â° Cache TTL: {config.CACHE_TTL}s')
          
          # Tests funcionales completos
          calc = Calculadora()
          
          test_cases = [
              (calc.sumar, [2, 3], 5),
              (calc.restar, [10, 4], 6),
              (calc.multiplicar, [3, 4], 12),
              (calc.dividir, [15, 3], 5.0),
              (calc.potencia, [2, 3], 8),
              (calc.raiz_cuadrada, [16], 4.0)
          ]
          
          for func, args, expected in test_cases:
              result = func(*args)
              assert result == expected, f'Test failed: {func.__name__}{args} = {result}, expected {expected}'
              print(f'âœ… {func.__name__}{args} = {result}')
          
          # Test de casos lÃ­mite
          try:
              calc.dividir(1, 0)
              assert False, 'DivisiÃ³n por cero deberÃ­a fallar'
          except ValueError:
              print('âœ… Control de divisiÃ³n por cero: OK')
          
          try:
              calc.raiz_cuadrada(-1)
              assert False, 'RaÃ­z de negativo deberÃ­a fallar'
          except ValueError:
              print('âœ… Control de raÃ­z negativa: OK')
          
          print('âœ… Integration tests de staging completados')
          "
          
      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Desplegando en entorno de STAGING..."
          
          # Deployment con blue-green simulation para staging
          echo "  ğŸ“ˆ Staging deployment config:"
          echo "    - Environment: ${{ env.ENVIRONMENT }}"
          echo "    - SSL Required: ${{ env.SSL_REQUIRED }}"
          echo "    - URL: ${{ env.WEB_URL }}"
          echo "    - Build: ${{ needs.build-staging.outputs.artifact-name }}"
          
          # Deployment cuidadoso para staging
          echo "  â–¶ Creando backup de la versiÃ³n actual..."
          sleep 2
          
          echo "  â–¶ Desplegando en blue environment..."
          sleep 3
          
          echo "  â–¶ Ejecutando health checks..."
          sleep 2
          
          echo "  â–¶ Switcheando trÃ¡fico a blue (staging)..."
          sleep 2
          
          echo "  â–¶ Validando deployment..."
          sleep 1
          
          echo "âœ… Deploy a staging completado"
          echo "ğŸ“Š MÃ©tricas de deployment:"
          echo "  - Tiempo total: ~10 segundos"
          echo "  - Downtime: 0 segundos (blue-green)"
          echo "  - Health checks: Passed"
          echo "  - SSL: Enabled"
          
      - name: ğŸ“ Update staging status
        run: |
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "deployment_url=${{ env.WEB_URL }}" >> $GITHUB_OUTPUT
          echo "environment=staging" >> $GITHUB_OUTPUT
          
  # ===============================================
  # JOB 3: POST-DEPLOYMENT PARA STAGING
  # ===============================================
  post-deploy-staging:
    name: ğŸ“Š Post-Deployment Staging
    runs-on: ubuntu-latest
    needs: [build-staging, deploy-staging]
    if: always()
    
    steps:
      - name: ğŸ“Š Staging metrics and monitoring
        run: |
          echo "ğŸ“Š MÃ©tricas del deployment de staging:"
          echo "  ğŸ—ï¸ Environment: staging"
          echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "  ğŸ“¦ Artifact: ${{ needs.build-staging.outputs.artifact-name }}"
          echo "  ğŸ”— URL: ${{ needs.build-staging.outputs.build-url }}"
          echo "  â±ï¸ Deploy time: $(date '+%H:%M:%S')"
          echo "  ğŸ“Š Status: ${{ needs.deploy-staging.result }}"
          echo "  ğŸ”’ Security: SSL enabled, Rate limited"
          
          # Simular envÃ­o de mÃ©tricas
          echo "  ğŸ“Š Enviando mÃ©tricas a sistema de monitoreo..."
          echo "    - Response time: 150ms"
          echo "    - Memory usage: 45MB"
          echo "    - CPU usage: 15%"
          
      - name: ğŸ“§ Team notification
        if: ${{ inputs.notify_team != false }}
        run: |
          if [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            echo "âœ… ğŸ“§ STAGING - Deploy exitoso - Listo para QA"
            echo "  ğŸ”— URL: ${{ needs.build-staging.outputs.build-url }}"
            echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
            echo "  ğŸ‘¤ Deployer: ${{ github.actor }}"
            echo "  ğŸ§ª Tests: Integration tests passed"
            echo "  ğŸ”’ Security: SSL enabled, Security scans completed"
            echo "  ğŸ“Š Coverage: >=90%"
            echo ""
            echo "  ğŸ“¢ @QATeam - Staging lista para validaciÃ³n"
          else
            echo "âŒ ğŸ“§ STAGING - Deploy fallÃ³"
            echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
            echo "  ğŸ‘¤ Deployer: ${{ github.actor }}"
            echo "  ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo ""
            echo "  ğŸ“¢ @DevTeam - Revisar logs de staging"
          fi
          
          # En un entorno real: notificaciÃ³n a Slack/Teams para QA team
          echo "ğŸ“§ NotificaciÃ³n de staging enviada al equipo"
          
      - name: ğŸ§¹ Staging cleanup and monitoring setup
        run: |
          echo "ğŸ§¹ ConfiguraciÃ³n de monitoreo y limpieza de staging:"
          echo "  - Artifacts: RetenciÃ³n 14 dÃ­as"
          echo "  - Logs: Nivel INFO configurado"
          echo "  - Monitoring: MÃ©tricas activadas"
          echo "  - Alerts: Configuradas para errores"
          echo "  - Health checks: Cada 5 minutos"
          echo "âœ… Staging configurado para monitoreo continuo"
