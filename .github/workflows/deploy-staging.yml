name: ğŸ­ Deploy to Staging

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Forzar despliegue (saltarse validaciones)'
        required: false
        default: false
        type: boolean

jobs:
  pre-deploy-checks:
    name: âœ… Validaciones Pre-Despliegue
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ§ª Suite Completa de Tests
      run: |
        echo "ğŸ§ª Ejecutando suite completa de tests para Staging..."
        python -m unittest discover -s . -p "test_*.py" -v
    
    - name: ğŸ“Š Verificar Cobertura
      run: |
        pip install coverage
        coverage run -m unittest discover -s . -p "test_*.py"
        coverage report --fail-under=90

  deploy-staging:
    name: ğŸ­ Despliegue a Staging
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: success() || inputs.force_deploy
    environment: 
      name: staging
      url: https://staging.calculadora-app.com
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ“‹ InformaciÃ³n del Despliegue Staging
      run: |
        echo "ğŸ­ === DESPLIEGUE A STAGING ==="
        echo "ğŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ğŸ†” Commit: ${{ github.sha }}" | cut -c1-8
        echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "ğŸ“… Fecha: $(date -Iseconds)"
        echo "ğŸ¯ Entorno: Staging"
        echo "ğŸ”— URL: https://staging.calculadora-app.com"
        echo "ğŸš¨ Forzado: ${{ inputs.force_deploy || 'false' }}"
    
    - name: ğŸ“¦ Build para Staging
      run: |
        echo "ğŸ”¨ Construyendo aplicaciÃ³n para Staging..."
        mkdir -p dist
        cp calculadora.py dist/
        echo "VERSION=$(git rev-parse --short HEAD)" > dist/.env
        echo "ENVIRONMENT=staging" >> dist/.env
        echo "BUILD_DATE=$(date -Iseconds)" >> dist/.env
        echo "DEPLOYED_BY=${{ github.actor }}" >> dist/.env
        echo "âœ… Build para Staging completado"
    
    - name: ğŸ” Validaciones de Seguridad
      run: |
        echo "ğŸ”’ Ejecutando validaciones de seguridad..."
        pip install bandit
        bandit -r . --exclude ./test_*.py || echo "âš ï¸ Advertencias de seguridad encontradas"
        echo "âœ… Validaciones de seguridad completadas"
    
    - name: ğŸš€ Despliegue a Staging
      run: |
        echo "ğŸš€ Desplegando a Staging..."
        echo "ğŸ“ Contenido a desplegar:"
        ls -la dist/
        echo ""
        echo "ğŸ”§ ConfiguraciÃ³n del entorno:"
        cat dist/.env
        echo ""
        echo "ğŸŒ Simulando despliegue a servidor de staging..."
        sleep 3
        echo "âœ… AplicaciÃ³n desplegada exitosamente en Staging"
        echo "ğŸ”— Disponible en: https://staging.calculadora-app.com"
    
    - name: ğŸ§ª Tests de IntegraciÃ³n
      run: |
        echo "ğŸ§ª Ejecutando tests de integraciÃ³n en Staging..."
        python calculadora.py
        echo "ğŸ” Verificando endpoints simulados..."
        echo "âœ… Tests de integraciÃ³n pasaron correctamente"
    
    - name: ğŸ“Š Reporte de Despliegue
      run: |
        echo "ğŸ“¢ === REPORTE DE DESPLIEGUE STAGING ==="
        echo "âœ… Despliegue a Staging completado exitosamente"
        echo "ğŸ‘¤ Por: ${{ github.actor }}"
        echo "ğŸ†” Commit: ${{ github.sha }}"
        echo "â° En: $(date)"
        echo "ğŸ”— URL: https://staging.calculadora-app.com"
        echo ""
        echo "ğŸ“‹ Listo para Production:"
        echo "- Crear tag de release (ej: v1.0.0)"
        echo "- Ejecutar workflow de producciÃ³n"
        echo "- Monitorear mÃ©tricas en staging"