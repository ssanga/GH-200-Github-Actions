name: ğŸš€ Deploy to Development

on:
  workflow_run:
    workflows: ["ğŸ”¨ Build and Test"]
    types:
      - completed
    branches: [ development ]
  workflow_dispatch:
    inputs:
      artifact_name:
        description: 'Nombre del artefacto a desplegar'
        required: false
        type: string

jobs:
  deploy-dev:
    name: ğŸ› ï¸ Despliegue a Development
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: 
      name: development
      url: https://dev.calculadora-app.com
    
    steps:
    - name: ğŸ“‹ InformaciÃ³n del Despliegue
      run: |
        echo "ğŸš€ === DESPLIEGUE A DEVELOPMENT ==="
        echo "ğŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ğŸ†” Workflow Run: ${{ github.event.workflow_run.id || 'Manual' }}"
        echo "ğŸ“… Fecha: $(date -Iseconds)"
        echo "ğŸ¯ Entorno: Development"
        echo "ğŸ”— URL: https://dev.calculadora-app.com"
    
    - name: ğŸ“¥ Descargar Artefacto de Build
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact_name || format('calculadora-development-{0}', github.sha) }}
        path: ./artifacts
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“¦ Extraer y Preparar Artefacto
      run: |
        echo "ğŸ“¦ Extrayendo artefacto para Development..."
        cd artifacts
        
        # Buscar el archivo ZIP
        ARTIFACT_ZIP=$(find . -name "*.zip" | head -1)
        if [ -n "$ARTIFACT_ZIP" ]; then
          echo "ğŸ“ Encontrado artefacto: $ARTIFACT_ZIP"
          unzip -q "$ARTIFACT_ZIP"
          ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
          echo "ğŸ“‚ Directorio extraÃ­do: $ARTIFACT_DIR"
          
          # Mostrar informaciÃ³n del build
          echo "ğŸ“‹ InformaciÃ³n del build:"
          cat "$ARTIFACT_DIR/build-info.json" | python3 -m json.tool
          
          # Configurar para development
          echo "ENVIRONMENT=development" >> "$ARTIFACT_DIR/.env"
          echo "DEPLOYED_AT=$(date -Iseconds)" >> "$ARTIFACT_DIR/.env"
          echo "DEPLOYED_BY=${{ github.actor }}" >> "$ARTIFACT_DIR/.env"
        else
          echo "âŒ No se encontrÃ³ artefacto ZIP"
          exit 1
        fi
    
    - name: ğŸš€ Desplegar a Development
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ğŸš€ Desplegando a Development..."
        echo "ğŸ“ Contenido a desplegar:"
        ls -la "$ARTIFACT_DIR/"
        echo ""
        echo "ğŸ”§ ConfiguraciÃ³n del entorno:"
        cat "$ARTIFACT_DIR/.env" 2>/dev/null || echo "No hay archivo .env"
        echo ""
        echo "ğŸŒ Simulando despliegue a servidor de desarrollo..."
        sleep 2
        echo "âœ… AplicaciÃ³n desplegada exitosamente en Development"
        echo "ğŸ”— Disponible en: https://dev.calculadora-app.com"
    
    - name: ğŸ§ª Tests de Humo Post-Despliegue
      run: |
        cd artifacts
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ğŸ§ª Ejecutando tests de humo..."
        cd "$ARTIFACT_DIR"
        python calculadora.py
        echo "âœ… Tests de humo pasaron correctamente"
    
    - name: ğŸ“Š NotificaciÃ³n de Despliegue
      run: |
        echo "ğŸ“¢ === NOTIFICACIÃ“N DE DESPLIEGUE ==="
        echo "âœ… Despliegue a Development completado exitosamente"
        echo "ğŸ‘¤ Por: ${{ github.actor }}"
        echo "ğŸ†” Commit: ${{ github.sha }}"
        echo "â° En: $(date)"
        echo "ğŸ”— URL: https://dev.calculadora-app.com"
        echo ""
        echo "ğŸ“‹ PrÃ³ximos pasos:"
        echo "- Verificar funcionalidad en Development"
        echo "- Crear PR hacia main para Staging"
        echo "- Ejecutar tests de integraciÃ³n"