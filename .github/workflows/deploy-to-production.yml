name: ðŸ­ Deploy to Production Only

on:
  workflow_dispatch:
    inputs:
      artifact_run_id:
        description: 'ID del workflow run que generÃ³ el artefacto (ej: 123456789)'
        required: true
        type: string
      artifact_name:
        description: 'Nombre del artefacto a desplegar (opcional, se auto-detecta)'
        required: false
        type: string
      version:
        description: 'VersiÃ³n/tag para documentaciÃ³n (opcional)'
        required: false
        type: string
      skip_validations:
        description: 'Saltar validaciones crÃ­ticas (solo emergencias)'
        required: false
        default: false
        type: boolean

jobs:
  validate-artifact:
    name: ðŸ” Validar Artefacto Existente
    runs-on: ubuntu-latest
    
    outputs:
      artifact-name: ${{ steps.detect.outputs.artifact-name }}
      source-run-url: ${{ steps.detect.outputs.source-run-url }}
      source-commit: ${{ steps.detect.outputs.source-commit }}
      source-branch: ${{ steps.detect.outputs.source-branch }}
    
    steps:
    - name: ðŸ“‹ InformaciÃ³n del Despliegue a ProducciÃ³n
      run: |
        echo "ðŸ­ === DESPLIEGUE A PRODUCCIÃ“N (SOLO DEPLOY) ==="
        echo "ðŸ‘¤ Solicitado por: ${{ github.actor }}"
        echo "ðŸ†” Artifact Run ID: ${{ inputs.artifact_run_id }}"
        echo "ðŸ“¦ Artifact Name: ${{ inputs.artifact_name || 'Auto-detectar' }}"
        echo "ðŸ·ï¸ VersiÃ³n: ${{ inputs.version || 'No especificada' }}"
        echo "âš ï¸ Skip Validations: ${{ inputs.skip_validations }}"
        echo "ðŸ“… Fecha: $(date -Iseconds)"
        echo ""
        echo "ðŸŽ¯ ESTRATEGIA: Reutilizar artefacto existente (NO recompilar)"
    
    - name: ðŸ” Obtener InformaciÃ³n del Workflow Original
      id: detect
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RUN_ID="${{ inputs.artifact_run_id }}"
        
        echo "ðŸ” Obteniendo informaciÃ³n del workflow run: $RUN_ID"
        
        # Obtener informaciÃ³n del run original usando GitHub CLI
        echo "ðŸ“¡ Consultando GitHub API..."
        
        # Construir URLs
        SOURCE_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/$RUN_ID"
        echo "source-run-url=$SOURCE_RUN_URL" >> $GITHUB_OUTPUT
        
        # Para este ejemplo, simularemos la detecciÃ³n del artefacto
        if [ -n "${{ inputs.artifact_name }}" ]; then
          ARTIFACT_NAME="${{ inputs.artifact_name }}"
        else
          # Auto-detectar nombre del artefacto (patrÃ³n calculadora-*)
          ARTIFACT_NAME="calculadora-from-run-$RUN_ID"
        fi
        
        echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
        echo "source-commit=unknown" >> $GITHUB_OUTPUT
        echo "source-branch=unknown" >> $GITHUB_OUTPUT
        
        echo "âœ… Artefacto detectado: $ARTIFACT_NAME"
        echo "ðŸ”— Workflow original: $SOURCE_RUN_URL"
    
    - name: ðŸ“¥ Verificar Disponibilidad del Artefacto
      uses: actions/download-artifact@v4
      with:
        name: ${{ steps.detect.outputs.artifact-name }}
        run-id: ${{ inputs.artifact_run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./verify-artifact
    
    - name: âœ… Validar Integridad del Artefacto
      run: |
        echo "ðŸ” Validando integridad del artefacto..."
        
        cd verify-artifact
        
        # Verificar que existe el ZIP
        if [ ! -f *.zip ]; then
          echo "âŒ No se encontrÃ³ archivo ZIP del artefacto"
          exit 1
        fi
        
        # Extraer y verificar contenido
        unzip -q *.zip
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        if [ -z "$ARTIFACT_DIR" ]; then
          echo "âŒ No se encontrÃ³ directorio del artefacto"
          exit 1
        fi
        
        # Verificar archivos crÃ­ticos
        if [ ! -f "$ARTIFACT_DIR/calculadora.py" ]; then
          echo "âŒ Archivo calculadora.py no encontrado"
          exit 1
        fi
        
        if [ ! -f "$ARTIFACT_DIR/build-info.json" ]; then
          echo "âŒ Archivo build-info.json no encontrado"
          exit 1
        fi
        
        echo "ðŸ“‹ InformaciÃ³n del build original:"
        cat "$ARTIFACT_DIR/build-info.json" | python3 -m json.tool
        
        echo "âœ… Artefacto vÃ¡lido y listo para producciÃ³n"

  deploy-production:
    name: ðŸ­ Desplegar a ProducciÃ³n
    runs-on: ubuntu-latest
    needs: validate-artifact
    environment: 
      name: production
      url: https://calculadora-app.com
    
    steps:
    - name: ðŸ“‹ InformaciÃ³n Final del Despliegue
      run: |
        echo "ðŸ­ === DESPLEGANDO A PRODUCCIÃ“N ==="
        echo "ðŸ“¦ Artefacto: ${{ needs.validate-artifact.outputs.artifact-name }}"
        echo "ðŸ”— Workflow origen: ${{ needs.validate-artifact.outputs.source-run-url }}"
        echo "ðŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "ðŸ·ï¸ VersiÃ³n: ${{ inputs.version || 'No especificada' }}"
        echo "ðŸ“… Fecha: $(date -Iseconds)"
        echo "âš ï¸ Skip Validations: ${{ inputs.skip_validations }}"
        echo ""
        echo "ðŸŽ¯ MODO: Despliegue directo (sin recompilaciÃ³n)"
    
    - name: ðŸ“¥ Descargar Artefacto para ProducciÃ³n
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.validate-artifact.outputs.artifact-name }}
        run-id: ${{ inputs.artifact_run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./production-deploy
    
    - name: ðŸ”’ Validaciones CrÃ­ticas de ProducciÃ³n
      if: inputs.skip_validations != true
      run: |
        echo "ðŸ”’ Ejecutando validaciones crÃ­ticas para ProducciÃ³n..."
        
        cd production-deploy
        unzip -q *.zip
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸ” Validaciones de seguridad..."
        
        # Verificar que no hay archivos de desarrollo
        if [ -f "$ARTIFACT_DIR/.env" ]; then
          echo "âš ï¸ Encontrado archivo .env existente, serÃ¡ sobrescrito"
        fi
        
        # Verificar integridad de archivos crÃ­ticos
        cd "$ARTIFACT_DIR"
        
        echo "ðŸ§ª Ejecutando test crÃ­tico de funcionalidad..."
        python calculadora.py > /dev/null 2>&1
        if [ $? -eq 0 ]; then
          echo "âœ… Test crÃ­tico de funcionalidad: OK"
        else
          echo "âŒ Test crÃ­tico de funcionalidad: FALLO"
          exit 1
        fi
        
        echo "âœ… Todas las validaciones crÃ­ticas pasaron"
    
    - name: âš ï¸ Saltar Validaciones (Modo Emergencia)
      if: inputs.skip_validations == true
      run: |
        echo "âš ï¸ === MODO EMERGENCIA ACTIVADO ==="
        echo "ðŸš¨ Se han saltado las validaciones crÃ­ticas"
        echo "ðŸš¨ Este despliegue es bajo tu responsabilidad"
        echo "ðŸš¨ Monitorea cuidadosamente el sistema despuÃ©s del despliegue"
    
    - name: ðŸ“¦ Preparar para ProducciÃ³n
      run: |
        cd production-deploy
        unzip -q *.zip
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸ“¦ Preparando configuraciÃ³n de ProducciÃ³n..."
        
        # Configurar variables de entorno especÃ­ficas de producciÃ³n
        cat > "$ARTIFACT_DIR/.env" << EOF
        # === CONFIGURACIÃ“N DE PRODUCCIÃ“N ===
        ENVIRONMENT=production
        DEPLOYED_AT=$(date -Iseconds)
        DEPLOYED_BY=${{ github.actor }}
        DEPLOYMENT_RUN_ID=${{ github.run_id }}
        SOURCE_RUN_ID=${{ inputs.artifact_run_id }}
        VERSION=${{ inputs.version || 'unspecified' }}
        
        # ConfiguraciÃ³n de producciÃ³n
        LOG_LEVEL=ERROR
        DEBUG=false
        MONITORING=true
        HIGH_AVAILABILITY=true
        PERFORMANCE_MODE=optimized
        SECURITY_LEVEL=maximum
        
        # Metadatos del despliegue
        DEPLOYMENT_TYPE=artifact-reuse
        SKIP_VALIDATIONS=${{ inputs.skip_validations }}
        EOF
        
        echo "âœ… ConfiguraciÃ³n de ProducciÃ³n aplicada"
        echo ""
        echo "ðŸ”§ ConfiguraciÃ³n final:"
        cat "$ARTIFACT_DIR/.env"
    
    - name: ðŸ’¾ Backup Pre-Despliegue
      run: |
        echo "ðŸ’¾ Simulando backup de la versiÃ³n actual de ProducciÃ³n..."
        BACKUP_ID="backup-$(date +%Y%m%d-%H%M%S)"
        echo "ðŸ—ƒï¸ Backup ID: $BACKUP_ID"
        echo "ðŸ“ Backup location: /backups/production/$BACKUP_ID"
        echo "âœ… Backup completado (simulado)"
    
    - name: ðŸš€ Despliegue Final a ProducciÃ³n
      run: |
        cd production-deploy
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        
        echo "ðŸš€ === DESPLEGANDO A PRODUCCIÃ“N ==="
        echo ""
        echo "ðŸ“ Contenido final a desplegar:"
        ls -la "$ARTIFACT_DIR/"
        echo ""
        echo "ðŸ”§ ConfiguraciÃ³n de producciÃ³n:"
        cat "$ARTIFACT_DIR/.env"
        echo ""
        echo "ðŸ­ Ejecutando despliegue crÃ­tico a ProducciÃ³n..."
        echo "  ðŸ”„ Deteniendo servicios actuales..."
        sleep 1
        echo "  ðŸ“¦ Desplegando nueva versiÃ³n..."
        sleep 2
        echo "  ðŸ”§ Aplicando configuraciÃ³n de producciÃ³n..."
        sleep 1
        echo "  ðŸš€ Iniciando servicios..."
        sleep 2
        echo "  ðŸ” Verificando health checks..."
        sleep 1
        echo ""
        echo "âœ… DESPLIEGUE A PRODUCCIÃ“N COMPLETADO"
        echo "ðŸ”— AplicaciÃ³n disponible en: https://calculadora-app.com"
    
    - name: ðŸ§ª Tests Post-Despliegue CrÃ­ticos
      run: |
        cd production-deploy
        ARTIFACT_DIR=$(find . -type d -name "calculadora-*" | head -1)
        cd "$ARTIFACT_DIR"
        
        echo "ðŸ§ª Ejecutando tests post-despliegue crÃ­ticos..."
        
        # Test de funcionalidad bÃ¡sica
        echo "ðŸ” Test de funcionalidad bÃ¡sica..."
        python calculadora.py
        
        # Simular health checks
        echo "ðŸ’“ Health checks..."
        echo "  âœ… API Response: OK"
        echo "  âœ… Database Connection: OK"
        echo "  âœ… External Services: OK"
        echo "  âœ… Memory Usage: Normal"
        echo "  âœ… CPU Usage: Normal"
        
        echo "âœ… Todos los tests post-despliegue pasaron"
    
    - name: ðŸ“Š Reporte Final de ProducciÃ³n
      run: |
        echo "ðŸŽ‰ === DESPLIEGUE A PRODUCCIÃ“N COMPLETADO EXITOSAMENTE ==="
        echo ""
        echo "ðŸ“‹ Resumen del Despliegue:"
        echo "  ðŸ­ Entorno: Production"
        echo "  ðŸ“¦ Artefacto: ${{ needs.validate-artifact.outputs.artifact-name }}"
        echo "  ðŸ”— Workflow origen: ${{ needs.validate-artifact.outputs.source-run-url }}"
        echo "  ðŸ‘¤ Desplegado por: ${{ github.actor }}"
        echo "  ðŸ·ï¸ VersiÃ³n: ${{ inputs.version || 'No especificada' }}"
        echo "  ðŸ“… Completado: $(date -Iseconds)"
        echo "  âš ï¸ Validaciones saltadas: ${{ inputs.skip_validations }}"
        echo ""
        echo "ðŸ”— URLs:"
        echo "  ðŸ­ ProducciÃ³n: https://calculadora-app.com"
        echo "  ðŸ“Š Monitoreo: https://monitoring.calculadora-app.com"
        echo ""
        echo "ðŸ“‹ Acciones Post-Despliegue Recomendadas:"
        echo "  ðŸ” Monitorear mÃ©tricas de aplicaciÃ³n durante 30 minutos"
        echo "  ðŸ“Š Verificar logs de errores en tiempo real"
        echo "  ðŸ‘¥ Confirmar funcionalidad con usuarios clave"
        echo "  ðŸ“ˆ Revisar mÃ©tricas de rendimiento"
        echo "  ðŸš¨ Tener plan de rollback listo si es necesario"
        echo ""
        echo "ðŸŽ¯ Estrategia utilizada: ReutilizaciÃ³n de artefacto (Build Once, Deploy Many)"
        echo "âœ… No se recompilÃ³ cÃ³digo - Despliegue eficiente y seguro"